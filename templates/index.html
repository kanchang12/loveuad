<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/static/manifest.json">
    <script defer src="https://cloud.umami.is/script.js" data-website-id="7ced9337-05c2-4ff5-b007-78fb65904c7c"></script>
    <meta name="theme-color" content="#667eea">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>LoveUAD | Premium Medical Care</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');



:root {
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-card: #ffffff;
    --bg-glass: rgba(255, 255, 255, 0.95);
    --text-primary: #0f172a;
    --text-secondary: #64748b;
    --accent-primary: #6366f1;
    --accent-secondary: #8b5cf6;
    --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    --premium-gradient: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 24px rgba(0, 0, 0, 0.12);
    --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.15);
    --border-color: rgba(226, 232, 240, 1);
    --hover-bg: rgba(99, 102, 241, 0.05);
    --card-sun-1: #ffe08a;
    --card-sun-2: #f6c453;
    --card-cream: #fff7e0;
    --card-border: #f0d18b;
    --card-shadow: 0 18px 30px rgba(31, 41, 55, 0.14);
    --card-shadow-soft: 0 10px 18px rgba(31, 41, 55, 0.1);
    --card-sky: #3b5bfd;
    --card-sky-dark: #2f46c9;
}

/* Combined App Container */
.app-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 60px 20px;
    animation: fadeIn 0.6s ease;
}

/* Missing Keyframes for the Logo */
@keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0px); }
}

.role-selection {
    width: 100%;
    max-width: 500px;
    display: flex;
    flex-direction: column;
    gap: 24px;
    align-items: center;
    margin: 24px auto; /* Added margin for spacing */
}

.role-card {
    width: 100%;
    max-width: 450px;
    margin: 0 auto;
}

body.dark-mode {
    --bg-primary: #0f0f23;
    --bg-secondary: #1a1a2e;
    --bg-card: #16213e;
    --bg-glass: rgba(22, 33, 62, 0.95);
    --text-primary: #ffffff;
    --text-secondary: #94a3b8;
    --border-color: rgba(99, 102, 241, 0.2);
    --shadow-sm: 0 2px 12px rgba(0, 0, 0, 0.4);
    --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.5);
    --shadow-lg: 0 16px 40px rgba(0, 0, 0, 0.6);
    --shadow-xl: 0 24px 56px rgba(0, 0, 0, 0.7);
}


        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.08) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.08) 0px, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .logo-container { text-align: center; margin-bottom: 48px; }
        .logo-icon {
            width: 100px; height: 100px; 
            background: var(--accent-gradient);
            border-radius: 24px; display: flex;
            align-items: center; justify-content: center;
            margin: 0 auto 24px;
            box-shadow: var(--shadow-xl), 0 0 0 8px rgba(99, 102, 241, 0.15);
            animation: float 3s ease-in-out infinite;
        }

        .onboarding-screen {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-primary);
    background-image: 
        radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.08) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.08) 0px, transparent 50%);
    z-index: 10001;
    overflow-y: auto;
}

.onboarding-screen.active { display: flex; }

.onboarding-container {
    width: 100%;
    max-width: 500px;
    margin: auto;
    padding: 60px 20px 40px;
    text-align: center;
}

.onboarding-slide {
    display: none;
    animation: fadeIn 0.5s ease;
}

.onboarding-slide.active { display: block; }

.onboarding-emoji {
    font-size: 96px;
    margin-bottom: 32px;
    animation: float 3s ease-in-out infinite;
}

.onboarding-title {
    font-size: 32px;
    font-weight: 900;
    color: var(--text-primary);
    margin-bottom: 16px;
    letter-spacing: -1px;
}

.onboarding-text {
    font-size: 18px;
    color: var(--text-secondary);
    font-weight: 600;
    line-height: 1.7;
    max-width: 400px;
    margin: 0 auto;
}

.onboarding-dots {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin: 48px 0 32px;
}

.onboarding-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(102, 126, 234, 0.3);
    transition: all 0.3s;
}

.onboarding-dot.active {
    background: var(--accent-primary);
    width: 28px;
    border-radius: 5px;
}

.onboarding-controls {
    display: flex;
    gap: 12px;
    margin-top: 24px;
}
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .logo-icon svg { filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
        .app-title { 
            font-size: 56px; font-weight: 900; 
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -2px;
            text-shadow: 0 0 60px rgba(99, 102, 241, 0.5);
        }
        .app-tagline { 
            font-size: 20px; font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .app-subtitle { 
            font-size: 16px; 
            color: var(--text-secondary); 
            font-weight: 500;
        }

        .disclaimer-box {
            background: rgba(252, 129, 129, 0.1);
            border-left: 4px solid #fc8181;
            backdrop-filter: blur(10px);
            padding: 24px; border-radius: 20px; 
            margin: 32px 0; max-width: 540px;
            box-shadow: var(--shadow-sm);
        }
        .disclaimer-box strong { color: #c53030; font-weight: 800; }
        .disclaimer-box p { color: #742a2a; font-size: 15px; line-height: 1.8; font-weight: 500; }

        .role-selection { width: 100%; max-width: 480px; display: flex; flex-direction: column; gap: 24px; }
        .role-card {
            background: var(--bg-card);
            border-radius: 24px; padding: 32px;
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; gap: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        .role-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity 0.4s;
        }
        
        .role-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: var(--shadow-xl);
            border-color: var(--accent-primary);
        }
        
        .role-card:hover::before { opacity: 1; }
        .role-card:hover .role-content { position: relative; z-index: 1; color: white; }
        .role-card:hover .role-title,
        .role-card:hover .role-description { color: white !important; opacity: 1; }
        
        .role-icon {
            width: 80px; height: 80px; 
            background: var(--accent-gradient);
            border-radius: 20px; display: flex;
            align-items: center; justify-content: center;
            font-size: 40px; flex-shrink: 0;
            box-shadow: var(--shadow-md);
            position: relative;
            z-index: 2;
        }
        .role-content { flex: 1; }
        .role-title { font-size: 26px; font-weight: 800; margin-bottom: 10px; transition: color 0.3s; }
        .role-description { font-size: 16px; opacity: 0.8; font-weight: 500; transition: color 0.3s; }

        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(26, 32, 44, 0.7);
            backdrop-filter: blur(12px);
            z-index: 1000;
            align-items: center; justify-content: center; padding: 20px;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-card);
            border-radius: 24px; padding: 40px;
            max-width: 560px; width: 100%; 
            max-height: 90vh; overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
        }
        
        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(40px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .modal-title { 
            font-size: 32px; font-weight: 900; 
            color: var(--text-primary); 
            margin-bottom: 10px;
            letter-spacing: -0.8px;
        }
        .modal-subtitle { 
            font-size: 16px; color: var(--text-secondary); 
            margin-bottom: 36px; font-weight: 600;
        }

        .form-group { margin-bottom: 28px; }
        .form-label { 
            display: block; font-size: 13px; font-weight: 700; 
            color: var(--text-primary); margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        .form-input, select.form-input {
            width: 100%; padding: 16px 20px; font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.2s;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: 500;
        }
        .form-input:focus { 
            outline: none; 
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background: var(--bg-card);
        }

        .btn {
            width: 100%; padding: 20px; font-size: 16px; font-weight: 800;
            border: none; border-radius: 18px; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center; justify-content: center; gap: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-size: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        @keyframes pulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
    50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
}

@keyframes avatarGlow {
    0%, 100% { box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3); }
    50% { box-shadow: 0 8px 40px rgba(99, 102, 241, 0.6); }
}

#aiAvatar.listening {
    animation: avatarGlow 2s ease-in-out infinite;
}

#listeningRing.active {
    opacity: 1;
    animation: pulse 2s ease-in-out infinite;
}

#voiceChatBtn:hover {
    transform: scale(1.05);
    box-shadow: 0 12px 32px rgba(99, 102, 241, 0.5);
}

#voiceChatBtn:active {
    transform: scale(0.95);
}
        
        .btn:hover::before {
            width: 320px;
            height: 320px;
        }
        
        .btn:active { transform: scale(0.98); }
        .btn-primary { 
            background: var(--accent-gradient);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-primary:hover { 
            box-shadow: var(--shadow-lg);
            transform: translateY(-3px);
        }
        .btn-primary:disabled { 
            background: #cbd5e1; 
            cursor: not-allowed;
            transform: none;
        }
        .btn-success { 
            background: var(--success-gradient);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-success:hover { 
            box-shadow: var(--shadow-lg);
            transform: translateY(-3px);
        }
        .btn-secondary { 
            background: var(--bg-primary);
            color: var(--text-primary);
            margin-top: 16px;
            box-shadow: var(--shadow-sm);
            border: 2px solid rgba(102, 126, 234, 0.2);
        }
        .btn-secondary:hover { 
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border-color: var(--accent-primary);
        }

        .dashboard { display: none; min-height: 100vh; background: var(--bg-primary); }
        .dashboard.active { display: block; animation: fadeIn 0.5s ease; }
        .dashboard-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 24px 28px;
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; 
            align-items: center; flex-wrap: wrap; gap: 20px;
            backdrop-filter: blur(12px);
        }
        .settings-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 12px 20px;
            border-radius: 12px; cursor: pointer; 
            font-size: 13px; font-weight: 700;
            color: var(--text-secondary);
            transition: all 0.2s;
            letter-spacing: 0.3px;
            display: inline-block;
            white-space: nowrap;
        }
        .settings-btn:hover {
            background: var(--hover-bg);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        .user-info { display: flex; align-items: center; gap: 20px; }
        .user-avatar {
            width: 64px; height: 64px;
            background: var(--accent-gradient);
            border-radius: 20px; display: flex;
            align-items: center; justify-content: center;
            color: white; font-weight: 900; font-size: 24px;
            box-shadow: var(--shadow-md);
        }
        .user-details h3 { 
            font-size: 20px; font-weight: 800; 
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }
        .user-details p { 
            font-size: 12px; color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        .dashboard-content { padding: 36px 28px; max-width: 1200px; margin: 0 auto; }

        .feature-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px; margin-bottom: 40px;
        }
        .feature-btn {
            background: var(--bg-card);
            padding: 28px 20px; 
            border-radius: 20px;
            border: 1px solid var(--border-color);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .feature-btn.patient-btn {
            padding: 48px 32px;
            border-radius: 28px;
            border: 3px solid var(--border-color);
        }
        .feature-btn::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .feature-btn:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-primary);
        }
        .feature-btn:hover::before {
            opacity: 0.1;
        }
        .feature-btn-icon {
            font-size: 48px; margin-bottom: 16px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }
        .feature-btn.patient-btn .feature-btn-icon {
            font-size: 80px;
            margin-bottom: 24px;
        }
        .feature-btn-label {
            font-size: 15px; font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 0.3px;
        }
        .feature-btn.patient-btn .feature-btn-label {
            font-size: 24px;
            font-weight: 800;
        }

        .med-list-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 28px;
            border-radius: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .med-list-item::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 4px;
            background: var(--accent-gradient);
        }
        .med-list-item:hover {
            transform: translateX(8px);
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-md);
        }
        
        .feature-btn-icon { 
            font-size: 44px; margin-bottom: 14px;
            transition: transform 0.3s;
        }
        .feature-btn:hover .feature-btn-icon {
            transform: scale(1.15);
        }

        .screen-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 24px 28px;
            position: sticky; top: 0; z-index: 100;
            display: flex; align-items: center; gap: 24px; flex-wrap: wrap;
        }
        .back-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 12px 20px;
            border-radius: 12px; cursor: pointer;
            font-size: 14px; font-weight: 700;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .back-btn:hover {
            background: var(--hover-bg);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        .screen-title { 
            font-size: 28px; font-weight: 900; 
            color: var(--text-primary); flex: 1;
            letter-spacing: -0.8px;
        }
        .screen-content { padding: 36px 28px; max-width: 1200px; margin: 0 auto; }
        
        .camera-screen, .medications-screen, .reminders-screen, .health-screen, .aiAnalysis-screen {
            display: none; min-height: 100vh; background: var(--bg-primary);
        }
        .camera-screen.active, .medications-screen.active, .reminders-screen.active, .health-screen.active, .aiAnalysis-screen.active {
            display: block; animation: fadeIn 0.5s ease;
        }
        
        .camera-container {
            max-width: 640px; margin: 0 auto; 
            background: var(--bg-card);
            border-radius: 24px; padding: 32px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        #cameraVideo {
            width: 100%;
            border-radius: 20px;
            background: #000;
            margin: 20px 0;
        }

        .capture-btn {
            background: var(--accent-gradient);
            color: white;
            padding: 20px 40px;
            border: none;
            border-radius: 18px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .capture-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .toast {
            position: fixed; bottom: 36px; left: 50%; 
            transform: translateX(-50%);
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            color: white; padding: 18px 32px;
            border-radius: 16px; font-size: 15px; font-weight: 700;
            display: none; z-index: 2000; 
            max-width: 90vw; text-align: center;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }
        .toast.show { 
            display: block; 
            animation: toastSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes toastSlideUp {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .empty-state { text-align: center; padding: 100px 20px; }
        .empty-icon { 
            font-size: 96px; margin-bottom: 28px;
            opacity: 0.7;
        }
        .empty-title { 
            font-size: 28px; font-weight: 900; 
            color: var(--text-primary); margin-bottom: 16px;
            letter-spacing: -0.8px;
        }
        .empty-text { 
            color: var(--text-secondary); 
            font-size: 18px; margin-bottom: 36px;
            font-weight: 600;
        }

        .med-list-item {
            background: var(--bg-card);
            padding: 28px;
            border-radius: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .med-list-item::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 4px;
            background: var(--accent-gradient);
        }
        .med-list-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-primary);
        }
        .med-title { 
            font-size: 20px; font-weight: 800; 
            color: var(--text-primary); margin-bottom: 12px;
            letter-spacing: -0.3px;
        }
        .med-info { 
            color: var(--text-secondary); 
            font-size: 15px; margin-bottom: 10px;
            font-weight: 600;
        }
        .med-schedule { 
            display: flex; gap: 10px; 
            flex-wrap: wrap; margin-top: 16px;
        }
        .time-badge {
            background: var(--accent-gradient);
            color: white;
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            box-shadow: var(--shadow-sm);
        }

        .dark-mode-toggle {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 10px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            margin-left: 12px;
        }
        .dark-mode-toggle:hover { 
            transform: scale(1.1);
            background: var(--hover-bg);
            border-color: var(--accent-primary);
        }
        
        .terms-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin: 24px 0;
        }
        .terms-checkbox { 
            display: flex; align-items: start; 
            gap: 16px; cursor: pointer;
        }
        .terms-checkbox input[type="checkbox"] { 
            margin-top: 4px; width: 22px; height: 22px; 
            cursor: pointer; accent-color: var(--accent-primary);
        }
        .terms-checkbox label { 
            flex: 1; font-size: 15px; 
            color: var(--text-secondary); 
            line-height: 1.8; cursor: pointer;
            font-weight: 600;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .connection-status {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            padding: 10px 20px;
            background: var(--bg-primary);
            border-radius: 14px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        .connection-status.online {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.15), rgba(56, 161, 105, 0.15));
            border-color: #48bb78;
            color: #276749;
        }

        .connection-status.offline {
            background: linear-gradient(135deg, rgba(252, 129, 129, 0.15), rgba(245, 101, 101, 0.15));
            border-color: #fc8181;
            color: #742a2a;
        }

        .premium-badge {
            background: var(--premium-gradient);
            color: #ffffff;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 12px;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
        }
        
        @media (max-width: 768px) {
    .app-title { font-size: 28px; }
    .app-tagline { font-size: 16px; }
    .app-subtitle { font-size: 14px; }
    .logo-icon { width: 80px; height: 80px; }
    
    .modal-content { 
        padding: 24px; 
        max-width: 95vw;
    }
    .modal-title { font-size: 24px; }
    .modal-subtitle { font-size: 14px; }
    
    .dashboard-header {
        padding: 12px;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .user-info {
        flex: 1 1 100%;
        gap: 12px;
    }
    
    .user-avatar {
        width: 48px;
        height: 48px;
        font-size: 20px;
        border-radius: 12px;
    }
    
    .user-details h3 {
        font-size: 16px;
        line-height: 1.2;
    }
    
    .user-details p {
        font-size: 10px;
    }
    
    .settings-btn { 
        font-size: 0 !important;
        padding: 10px 14px !important;
        min-width: auto !important;
        border-radius: 10px !important;
    }
    
    .settings-btn::before {
        content: "‚ò∞";
        font-size: 24px;
    }
    
    .dark-mode-toggle { 
        min-width: auto !important;
        padding: 10px 14px !important;
        font-size: 20px;
    }
    
    .connection-status {
        font-size: 9px;
        padding: 6px 10px;
    }
    
    .dashboard-content { 
        padding: 12px; 
    }
    
    .screen-header {
        padding: 12px;
        gap: 10px;
    }
    
    .screen-title {
        font-size: 18px;
    }
    
    .back-btn {
        padding: 8px 14px;
        font-size: 13px;
    }
    
    .screen-content {
        padding: 12px;
    }
    
    #chatHistory {
        max-height: 350px !important;
        padding: 10px !important;
        margin-bottom: 12px !important;
    }
    
    #chatInput {
        padding: 12px 14px !important;
        font-size: 16px !important;
    }
    
    #voiceBtn {
        padding: 12px !important;
        min-width: 48px !important;
    }
    
    #voiceBtn span {
        font-size: 16px !important;
    }
    
    .btn {
        padding: 14px 20px !important;
        font-size: 14px !important;
    }
    
    .chat-message {
        font-size: 14px !important;
        padding: 12px 16px !important;
    }
    
    .disclaimer-box {
        padding: 16px !important;
        font-size: 13px !important;
    }
    
    .aiAnalysis-screen .screen-content > div {
        padding: 16px !important;
        border-radius: 16px !important;
        margin-bottom: 16px !important;
    }
    
    #calendarScreen .screen-content > div {
        padding: 12px !important;
        border-radius: 12px !important;
        margin-bottom: 12px !important;
    }
    
    #calendarScreen .screen-content > div > div:first-child {
        margin-bottom: 12px !important;
        gap: 8px !important;
    }
    
    #calendarScreen .screen-content > div > div:first-child button {
        padding: 8px 12px !important;
        font-size: 12px !important;
    }
    
    #calendarMonth {
        font-size: 16px !important;
    }
    
    #calendarScreen .screen-content > div > div:nth-child(2),
    #calendarScreen .screen-content > div > div:nth-child(3) {
        gap: 4px !important;
        margin-bottom: 12px !important;
    }
    
    #calendarScreen .screen-content > div > div:nth-child(2) > div {
        font-size: 10px !important;
        padding: 4px !important;
    }
    
    #calendarDays > div {
        font-size: 11px !important;
        padding: 4px !important;
        min-height: 50px;
    }
    
    #calendarScreen .screen-content > div > div:nth-child(4) {
        gap: 12px !important;
        margin-top: 12px !important;
        font-size: 12px !important;
    }
    
    #calendarScreen .screen-content > div > div:nth-child(4) > div {
        gap: 6px !important;
    }
    
    #calendarScreen .screen-content > div > div:nth-child(4) > div > div {
        width: 12px !important;
        height: 12px !important;
    }
    
    #healthScreen .screen-content > div {
        padding: 16px !important;
        border-radius: 16px !important;
        margin-bottom: 16px !important;
    }
    
    #healthScreen .screen-content > div > div:first-child {
        font-size: 18px !important;
        margin-bottom: 16px !important;
    }
    
    #healthScreen .screen-content input,
    #healthScreen .screen-content select {
        padding: 12px !important;
        font-size: 16px !important;
    }
    
    #healthScreen .screen-content > div > div:nth-child(2) {
        gap: 12px !important;
        margin-bottom: 16px !important;
        grid-template-columns: 1fr !important;
    }
    
    #bpChart, #sugarChart {
        min-height: 200px !important;
        padding: 12px !important;
    }
    
    .feature-grid { 
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
        gap: 10px;
    }
    
    .feature-btn {
        padding: 16px 12px;
    }
    
    .feature-btn-icon {
        font-size: 28px;
        margin-bottom: 6px;
    }
    
    .feature-btn-label {
        font-size: 11px;
    }
    
    .feature-btn.patient-btn {
        padding: 32px 24px;
    }
    
    .feature-btn.patient-btn .feature-btn-icon {
        font-size: 56px;
    }
    
    .feature-btn.patient-btn .feature-btn-label {
        font-size: 18px;
    }
    
    .role-card {
        padding: 24px;
        gap: 16px;
    }
    
    .role-icon {
        width: 60px;
        height: 60px;
        font-size: 30px;
    }
    
    .role-title {
        font-size: 20px;
    }
    
    .role-description {
        font-size: 14px;
    }
    
    .form-input {
        padding: 14px 16px;
        font-size: 16px;
    }
    
    .med-list-item {
        padding: 16px;
    }
    
    .med-title {
        font-size: 16px;
    }
    
    .med-info {
        font-size: 14px;
    }
    
    .time-badge {
        padding: 8px 14px;
        font-size: 13px;
    }
    
    .empty-icon {
        font-size: 64px;
    }
    
    .empty-title {
        font-size: 22px;
    }
    
    .empty-text {
        font-size: 15px;
    }
}

@media (max-width: 360px) {
    .app-title { font-size: 24px !important; }
    .user-details h3 { font-size: 14px !important; }
    .feature-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .feature-btn { padding: 12px 8px !important; }
    .feature-btn-icon { font-size: 24px !important; }
    .feature-btn-label { font-size: 10px !important; }
    .feature-btn.patient-btn { padding: 24px 16px !important; }
    .feature-btn.patient-btn .feature-btn-icon { font-size: 48px !important; }
    .feature-btn.patient-btn .feature-btn-label { font-size: 16px !important; }
    #chatHistory { max-height: 250px !important; }
    .modal-content { padding: 16px !important; }
    .form-input { font-size: 16px !important; }
}
    

/* Card redesign inspired by provided UI */
:root {
    --card-sun-1: #ffe08a;
    --card-sun-2: #f6c453;
    --card-cream: #fff7e0;
    --card-border: #f0d18b;
    --card-shadow: 0 18px 30px rgba(31, 41, 55, 0.14);
    --card-shadow-soft: 0 10px 18px rgba(31, 41, 55, 0.1);
    --card-sky: #3b5bfd;
    --card-sky-dark: #2f46c9;
}

.feature-btn {
    background: var(--card-cream);
    border: 2px solid var(--card-border);
    border-radius: 24px;
    box-shadow: var(--card-shadow-soft);
    padding: 36px 22px 28px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.feature-btn::before {
    top: 0;
    left: 0;
    right: 0;
    bottom: auto;
    height: 46px;
    background: linear-gradient(180deg, var(--card-sun-1) 0%, var(--card-sun-2) 100%);
    opacity: 1;
}

.feature-btn::after {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    height: 6px;
    background: linear-gradient(90deg, rgba(59, 91, 253, 0.45), rgba(59, 91, 253, 0));
}

.feature-btn > * {
    position: relative;
    z-index: 1;
}

.feature-btn:hover {
    transform: translateY(-6px);
    box-shadow: var(--card-shadow);
    border-color: #f2b642;
}

.feature-btn:hover::before {
    filter: brightness(1.03);
}

.feature-btn-icon {
    width: 56px;
    height: 56px;
    margin-bottom: 4px;
    border-radius: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    background: linear-gradient(180deg, var(--card-sky) 0%, var(--card-sky-dark) 100%);
    color: #ffffff;
    box-shadow: 0 10px 16px rgba(59, 91, 253, 0.35);
    filter: none;
}

.feature-btn-label {
    font-size: 15px;
    font-weight: 800;
    color: #1f2937;
    letter-spacing: 0.4px;
}

.feature-btn.patient-btn {
    padding: 50px 28px 38px;
    border-radius: 30px;
    border-width: 3px;
}

.feature-btn.patient-btn .feature-btn-icon {
    width: 86px;
    height: 86px;
    font-size: 40px;
    border-radius: 22px;
}

.feature-btn.patient-btn .feature-btn-label {
    font-size: 22px;
    font-weight: 900;
}

.med-list-item {
    background: #fffdf3;
    border: 1px solid var(--card-border);
    border-radius: 22px;
    padding: 26px 24px 22px;
    box-shadow: var(--card-shadow-soft);
}

.med-list-item::before {
    top: 0;
    left: 0;
    right: 0;
    width: 100%;
    bottom: auto;
    height: 28px;
    background: linear-gradient(180deg, var(--card-sun-1) 0%, var(--card-sun-2) 100%);
}

.med-list-item > * {
    position: relative;
    z-index: 1;
}

.med-list-item:hover {
    transform: translateY(-4px);
    box-shadow: var(--card-shadow);
    border-color: #f2b642;
}

.time-badge {
    background: #ffe08a;
    color: #1f2b5c;
    border: 1px solid #f2c463;
    box-shadow: none;
}

.ui-card {
    background: var(--card-cream) !important;
    border: 1px solid var(--card-border) !important;
    border-radius: 22px !important;
    box-shadow: var(--card-shadow-soft) !important;
    position: relative;
    overflow: hidden;
}

.ui-card::before {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    height: 40px;
    background: linear-gradient(180deg, var(--card-sun-1) 0%, var(--card-sun-2) 100%);
}

.ui-card > * {
    position: relative;
    z-index: 1;
}

.ui-subcard {
    background: #fff9ed !important;
    border: 1px solid #f1d6a4 !important;
    border-radius: 14px !important;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6) !important;
}

@media (max-width: 640px) {
    .feature-btn {
        padding: 24px 14px 20px;
        border-radius: 20px;
    }

    .feature-btn::before {
        height: 36px;
    }

    .feature-btn-icon {
        width: 44px;
        height: 44px;
        font-size: 22px;
        border-radius: 12px;
    }

    .feature-btn.patient-btn {
        padding: 36px 20px 26px;
    }

    .feature-btn.patient-btn .feature-btn-icon {
        width: 68px;
        height: 68px;
        font-size: 34px;
    }
}



/* ElevenLabs CBT voice widget */
.elevenlabs-widget {
    position: absolute;
    left: -9999px;
    top: 0;
    width: 1px;
    height: 1px;
    overflow: hidden;
    opacity: 0;
    pointer-events: none;
}

.elevenlabs-widget elevenlabs-convai {
    display: block;
}

.elevenlabs-widget elevenlabs-convai::part(launcher) {
    display: none;
}

.elevenlabs-widget elevenlabs-convai::part(button) {
    display: none;
}

</style>
    
</head>
<body>

    <!-- Onboarding Carousel -->
<div class="onboarding-screen" id="onboardingScreen">
    <div class="onboarding-container">
        <!-- Slide 1: Welcome -->
        <div class="onboarding-slide active" data-slide="0">
            <div class="onboarding-emoji">üíô</div>
            <h2 class="onboarding-title">Welcome to LoveUAD</h2>
            <p class="onboarding-text">Love You Always Dad<br>Premium Medical Care Platform for Dementia Patients & Caregivers</p>
        </div>

        <!-- Slide 2: Scan Prescriptions -->
        <div class="onboarding-slide" data-slide="1">
            <div class="onboarding-emoji">üì∏</div>
            <h2 class="onboarding-title">Scan Prescriptions</h2>
            <p class="onboarding-text">Simply take a photo of your prescription and we'll automatically extract medication details</p>
        </div>

        <!-- Slide 3: Smart Reminders -->
        <div class="onboarding-slide" data-slide="2">
            <div class="onboarding-emoji">‚è∞</div>
            <h2 class="onboarding-title">Never Miss a Dose</h2>
            <p class="onboarding-text">Get timely medication reminders with loud alarms, vibrations, and optional phone calls</p>
        </div>

        <!-- Slide 4: AI Health Insights -->
        <div class="onboarding-slide" data-slide="3">
            <div class="onboarding-emoji">ü§ñ</div>
            <h2 class="onboarding-title">AI Health Insights</h2>
            <p class="onboarding-text">Get personalized medication analysis and caregiving tips after scanning prescriptions</p>
        </div>

        <!-- Slide 5: Brain Games -->
        <div class="onboarding-slide" data-slide="4">
            <div class="onboarding-emoji">üß†</div>
            <h2 class="onboarding-title">Brain Games</h2>
            <p class="onboarding-text">Fun cognitive exercises - Math Garden, Word Friends, and Memory games to keep minds active</p>
        </div>

        <!-- Slide 6: AI Dementia Chat -->
        <div class="onboarding-slide" data-slide="5">
            <div class="onboarding-emoji">üí¨</div>
            <h2 class="onboarding-title">Ask Anything</h2>
            <p class="onboarding-text">24/7 caregiving advice - Ask, Talk, Discuss</p>
        </div>

        <!-- Slide 7: Caregiver Support -->
        <div class="onboarding-slide" data-slide="6">
            <div class="onboarding-emoji">üë®‚Äç‚öïÔ∏è</div>
            <h2 class="onboarding-title">Caregiver Support</h2>
            <p class="onboarding-text">Family members can remotely monitor medication adherence using secure anonymous patient codes</p>
        </div>

        <!-- Slide 8: Health Tracking -->
        <div class="onboarding-slide" data-slide="7">
            <div class="onboarding-emoji">üìä</div>
            <h2 class="onboarding-title">Track Health Data</h2>
            <p class="onboarding-text">Monitor medication adherence, blood pressure, blood sugar, and view detailed health charts</p>
        </div>

        <!-- Dots -->
        <div class="onboarding-dots" id="onboardingDots"></div>

        <!-- Controls -->
        <div class="onboarding-controls">
            <button class="btn btn-secondary" onclick="skipOnboarding()" id="skipBtn" style="flex: 1; margin: 0;">Skip</button>
            <button class="btn btn-primary" onclick="nextOnboardingSlide()" id="nextBtn" style="flex: 2; margin: 0;">Next</button>
        </div>
    </div>
</div>
    
    <div class="app-container" id="homeScreen">
        <div class="logo-container">
            <div class="logo-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C11.4477 2 11 2.44772 11 3V9H5C4.44772 9 4 9.44772 4 10V14C4 14.5523 4.44772 15 5 15H11V21C11 21.5523 11.4477 22 12 22C12.5523 22 13 21.5523 13 21V15H19C19.5523 15 20 14.5523 20 14V10C20 9.44772 19.5523 9 19 9H13V3C13 2.44772 12.5523 2 12 2Z" fill="white"/>
                    <circle cx="12" cy="12" r="9.5" stroke="white" stroke-width="1.5" fill="none"/>
                </svg>
            </div>
            <h1 class="app-title">LoveUAD</h1>
            <p class="app-tagline">Love You Always Dad</p>
            <p class="app-subtitle">Premium Medical Care Platform</p>
        </div>
        
            
        
        <div class="role-selection">
            <div class="role-card patient" onclick="selectRole('patient')">
                <div class="role-icon">üë§</div>
                <div class="role-content">
                    <div class="role-title">I'm a Patient</div>
                    <div class="role-description">Track medications and health</div>
                </div>
            </div>
            <div class="role-card caregiver" onclick="selectRole('caregiver')">
                <div class="role-icon">üë®‚Äç‚öïÔ∏è</div>
                <div class="role-content">
                    <div class="role-title">I'm a Caregiver</div>
                    <div class="role-description">Support your loved ones</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Options Modal -->
    <div class="modal" id="patientOptionsModal">
        <div class="modal-content">
            <h2 class="modal-title">Patient Access</h2>
            <p class="modal-subtitle">Choose your account type</p>
            <div style="display: flex; flex-direction: column; gap: 20px; margin: 24px 0;">
                <button class="btn btn-primary" onclick="selectPatientOption('new')" style="padding: 28px; font-size: 17px;">‚ú® New Patient - Register</button>
                <button class="btn btn-primary" onclick="selectPatientOption('existing')" style="padding: 28px; font-size: 17px;">üîë Existing Patient - Login</button>
            </div>
            <button class="btn btn-secondary" onclick="closeModal('patientOptionsModal')">Cancel</button>
        </div>
    </div>

    <!-- Patient Login Modal -->
    <div class="modal" id="patientLoginModal">
        <div class="modal-content">
            <h2 class="modal-title">Welcome Back</h2>
            <p class="modal-subtitle">Enter your patient code to continue</p>
            <div class="form-group">
                <label class="form-label">Patient Code</label>
                <input type="text" id="loginCode" class="form-input" placeholder="XXXX-XXXX-XXXX-XXXX-X" maxlength="21" style="font-family: monospace; text-transform: uppercase; font-size: 18px; font-weight: 700;" oninput="formatPatientCode(this)">
            </div>
            <button class="btn btn-success" onclick="loginExistingPatient()">Login</button>
            <button class="btn btn-secondary" onclick="closeModal('patientLoginModal'); openModal('patientOptionsModal')">Back</button>
        </div>
    </div>

    <!-- Patient Registration Modal -->
    <div class="modal" id="patientModal">
        <div class="modal-content">
            <h2 class="modal-title">Create Your Profile</h2>
            <p class="modal-subtitle">Join LoveUAD today</p>
            <div class="form-group">
                <label class="form-label">Display Name</label>
                <input type="text" id="displayName" class="form-input" placeholder="How should we address you?">
            </div>
            <div class="form-group">
                <label class="form-label">Age</label>
                <input type="number" id="patientAge" class="form-input" placeholder="Enter age" min="1" max="120">
            </div>
            <div class="form-group">
                <label class="form-label">Gender</label>
                <select id="patientGender" class="form-input">
                    <option value="">Select gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                    <option value="prefer-not-to-say">Prefer not to say</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Phone (Mandatory wit +91/+44 country code))</label>
                <input type="tel" id="phoneNumber" class="form-input" placeholder="(555) 123-4567">
            </div>
            <div class="terms-container">
                <div class="terms-checkbox">
                    <input type="checkbox" id="termsAccept">
                    <label for="termsAccept"><strong>I understand:</strong> This is a reminder app, not medical advice. I will consult healthcare professionals for medical decisions.</label>
                </div>
            </div>
            <button class="btn btn-primary" id="registerBtn" onclick="registerPatient()" disabled>Create Profile</button>
            <button class="btn btn-secondary" onclick="closeModal('patientModal'); openModal('patientOptionsModal')">Back</button>
        </div>
    </div>

    <!-- Code Display Modal -->
    <div class="modal" id="codeModal">
        <div class="modal-content">
            <h2 class="modal-title">Profile Created!</h2>
            <p class="modal-subtitle">Save your patient code</p>
            <div style="background: rgba(72, 187, 120, 0.1); color: #276749; padding: 24px; border-radius: 20px; margin-bottom: 28px; font-weight: 700;">‚úì Your encrypted profile is ready</div>
            <div style="background: var(--bg-primary); border: 3px solid var(--accent-primary); border-radius: 24px; padding: 32px; text-align: center; margin: 28px 0;">
                <div style="font-size: 12px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 20px; letter-spacing: 1.2px;">Connection Code</div>
                <div id="patientCode" style="font-size: 32px; font-weight: 900; color: var(--accent-primary); font-family: monospace; letter-spacing: 4px; word-break: break-all; margin-bottom: 24px;">XXXX-XXXX-XXXX-XXXX-X</div>
                <div style="font-size: 14px; color: var(--text-secondary); font-weight: 600; line-height: 1.6;">Share this code with your caregiver to connect</div>
            </div>
            <button class="btn btn-success" onclick="copyCode()">Copy Code</button>
            <button class="btn btn-primary" onclick="goToDashboard()">Continue</button>
        </div>
    </div>

    <!-- Caregiver Connect Modal -->
    <div class="modal" id="caregiverModal">
        <div class="modal-content">
            <h2 class="modal-title">Caregiver Login</h2>
            <p class="modal-subtitle">Enter patient code to access their data</p>
            <div class="form-group">
                <label class="form-label">Patient Code</label>
                <input type="text" id="caregiverCode" class="form-input" placeholder="XXXX-XXXX-XXXX-XXXX-X" maxlength="21" style="font-family: monospace; font-size: 18px; font-weight: 700; text-transform: uppercase;" oninput="formatPatientCode(this)">
            </div>
            <div class="terms-container">
                <div class="terms-checkbox">
                    <input type="checkbox" id="caregiverTerms">
                    <label for="caregiverTerms"><strong>I acknowledge:</strong> I am authorized to access this patient's health data.</label>
                </div>
            </div>
            <button class="btn btn-success" id="connectBtn" onclick="connectCaregiver()" disabled>Login as Caregiver</button>
            <button class="btn btn-secondary" onclick="closeModal('caregiverModal')">Cancel</button>
        </div>
    </div>

    <!-- Medication Schedule Modal -->
    <div class="modal" id="medScheduleModal">
        <div class="modal-content">
            <h2 class="modal-title">Confirm Schedule</h2>
            <p class="modal-subtitle">Review and adjust times</p>
            <div style="background: var(--bg-primary); border: 3px solid var(--accent-primary); border-radius: 24px; padding: 28px; margin: 28px 0;" id="medScheduleContainer"></div>
            
            <!-- Android Native Alarm Option -->
            <div id="androidAlarmOption" style="display:none!important;">
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                    <div style="font-size: 32px;">‚è∞</div>
                    <div style="flex: 1;">
                        <div style="font-size: 18px; font-weight: 800; color: #276749; margin-bottom: 4px;">Set Native Android Alarms</div>
                        <div style="font-size: 14px; color: #276749; font-weight: 600;">Native alarms can bypass Do Not Disturb mode</div>
                    </div>
                </div>
                <div class="terms-checkbox" style="margin-top: 16px;">
                    <input type="checkbox" id="useNativeAlarms" checked>
                    <label for="useNativeAlarms" style="color: #276749;"><strong>Open Clock app to set native alarms</strong> (Recommended for Android)</label>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="confirmMedicationSchedule()">Confirm & Enable</button>
            <button class="btn btn-secondary" onclick="closeModal('medScheduleModal')">Cancel</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2 class="modal-title">Settings</h2>
            <p class="modal-subtitle">Manage your profile</p>
            <div style="background: var(--bg-primary); border-radius: 24px; padding: 28px; margin: 28px 0;">
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 12px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1.2px;">Role</div>
                    <div id="settingsRole" style="font-size: 20px; font-weight: 900; color: var(--text-primary);">Patient</div>
                </div>
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 12px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1.2px;">Name</div>
                    <div id="settingsName" style="font-size: 20px; font-weight: 900; color: var(--text-primary);">User Name</div>
                </div>
                <div id="settingsTierSection" style="margin-bottom: 24px;">
                    <div style="font-size: 12px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1.2px;">Plan</div>
                    <div id="settingsTier" style="font-size: 20px; font-weight: 900; color: var(--text-primary);">Free</div>
                    <button class="btn btn-primary" onclick="toggleTier();" style="margin-top: 12px; padding: 14px; font-size: 14px; width: auto;" id="tierToggleBtn">‚ú® Upgrade to Premium</button>
                </div>
                <div id="settingsAgeGenderSection" style="margin-bottom: 24px; display: none;">
                    <div style="font-size: 12px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1.2px;">Age & Gender</div>
                    <div id="settingsAgeGender" style="font-size: 20px; font-weight: 900; color: var(--text-primary);">-</div>
                </div>
                
                <div id="settingsCodeSection" style="display: none;">
                    <div style="font-size: 12px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1.2px;">Connection Code</div>
                    <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 24px;">
                        <div id="settingsCode" style="font-size: 20px; font-weight: 900; color: var(--accent-primary); font-family: monospace; flex: 1;">XXXX</div>
                        <button class="btn btn-primary" onclick="copyCodeFromSettings()" style="width: auto; padding: 14px 24px;">Copy</button>
                    </div>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="openDeletionRequest()" style="background: var(--danger-gradient); color: white; margin: 0 0 12px 0;">
    üóëÔ∏è Request Account Deletion
</button>
            <button class="btn btn-secondary" onclick="logoutUser()" style="background: var(--accent-gradient); color: white; margin-top: 28px;">Logout</button>
            <div style="background: rgba(252, 129, 129, 0.1); border-left: 6px solid #fc8181; padding: 24px; border-radius: 20px; margin: 28px 0;">
                <div style="font-weight: 900; color: #c53030; margin-bottom: 16px; font-size: 18px;">‚ö†Ô∏è Danger Zone</div>
                <p style="color: #742a2a; font-size: 15px; margin-bottom: 20px; font-weight: 600;">Reset will delete ALL data permanently.</p>
                <button class="btn btn-secondary" onclick="confirmReset()" style="background: var(--danger-gradient); color: white; margin: 0;">Reset App</button>
            </div>
            <button class="btn btn-secondary" onclick="closeModal('settingsModal')">Close</button>
        </div>
    </div>

    <!-- HTML file - Add new modal after settings modal (around line 800) -->

<!-- HTML - Add new deletion modal after settings modal (around line 800) -->
<div class="modal" id="deletionModal">
    <div class="modal-content" style="max-width: 500px;">
        <h2 class="modal-title" style="color: #ef4444;">‚ö†Ô∏è Account Deletion Request</h2>
        <div style="background: rgba(252, 129, 129, 0.1); border-left: 4px solid #fc8181; padding: 20px; border-radius: 16px; margin: 24px 0;">
            <p style="color: #742a2a; font-size: 15px; font-weight: 600; line-height: 1.8; margin-bottom: 12px;">
                <strong>This will permanently delete:</strong>
            </p>
            <ul style="color: #742a2a; font-size: 14px; font-weight: 600; line-height: 2; margin-left: 20px;">
                <li>ALL health data and records</li>
                <li>ALL medication information</li>
                <li>ALL reminders and alarms</li>
                <li>Caregiver connections</li>
                <li>Your patient code</li>
            </ul>
            <p style="color: #c53030; font-size: 15px; font-weight: 800; margin-top: 16px;">
                Cannot be undone. Account deleted within 30 days.
            </p>
        </div>
        <div style="margin-bottom: 20px;">
            <p style="font-size: 14px; color: var(--text-secondary); font-weight: 600;">
                Patient Code: <strong id="deletionCode" style="color: var(--accent-primary); font-family: monospace;"></strong>
            </p>
        </div>
        <button class="btn btn-secondary" onclick="confirmDeletion()" style="background: #ef4444; color: white; margin-bottom: 12px;">
            Yes, Delete My Account
        </button>
        <button class="btn btn-secondary" onclick="closeModal('deletionModal')">
            Cancel
        </button>
    </div>
</div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboardScreen">
        <div class="dashboard-header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <h3 id="userName">User Name<span id="tierBadge"></span></h3>
                    <p id="userRole">Patient</p>
                    <p id="patientIdDisplay" style="display: none; font-size: 12px; color: var(--text-secondary); font-weight: 700; margin-top: 4px; font-family: monospace;">
    Patient ID: <span id="patientIdCode"></span> 
    <button onclick="navigator.clipboard.writeText(document.getElementById('patientIdCode').textContent); showToast('‚úì Copied!')" 
            style="background: var(--accent-primary); color: white; border: none; padding: 2px 8px; border-radius: 6px; font-size: 10px; cursor: pointer; margin-left: 6px;">üìã</button>
</p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <div class="connection-status" id="connectionStatus">
                    <span id="statusIcon">‚óè</span> <span id="statusText">CONNECTING</span>
                </div>
                <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">üåô</button>
                <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
            </div>
        </div>
        <div class="dashboard-content">
            <h2 style="font-size: 32px; font-weight: 900; color: var(--text-primary); margin-bottom: 28px; letter-spacing: -0.8px;">Quick Actions</h2>
            <div class="feature-grid" id="featureGrid">
                <!-- Features will be dynamically loaded based on tier -->
            </div>
            <div class="disclaimer-box">
                <p><strong>Reminder:</strong> This app helps track medications. It is NOT medical advice.</p>
                <p id="webAlarmWarning" style="margin-top: 14px;"><strong>‚ö†Ô∏è Silent Mode Alert:</strong> Phone will <strong>vibrate strongly</strong> even when silent. Audio plays when volume is on.</p>

            </div>
        </div>
    </div>

   <!-- Camera/Scanner Screen -->
    <div class="camera-screen" id="cameraScreen">
        <div class="screen-header">
            <button class="back-btn" onclick="closeCameraBack()"> </button>
            <div class="screen-title">Scan Prescription</div>
        </div>
        <div class="screen-content">
            <div class="camera-container">
                <h2 class="modal-title">Camera Scanner</h2>
                <p class="modal-subtitle" style="margin-bottom: 28px;">Take a photo of your prescription</p>
                
                <video id="cameraVideo" autoplay playsinline muted style="display: none; width: 100%; max-width: 100%; border-radius: 20px; background: #000;"></video>
                <canvas id="cameraCanvas" style="display: none;"></canvas>
                
                <div id="cameraControls">
                    <button class="btn btn-primary" onclick="startCamera()" id="startCameraBtn">üì∑ Start Camera</button>
                    <button class="btn btn-success" onclick="capturePhoto()" id="captureBtn" style="display: none;">‚úì Capture</button>
                    <button class="btn btn-secondary" onclick="stopCamera()" id="stopCameraBtn" style="display: none;">Stop Camera</button>
                </div>
                
                <div id="processingStatus" style="display: none; margin-top: 24px; padding: 20px; background: rgba(102, 126, 234, 0.1); border-radius: 16px; text-align: center;">
                    <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                    <div style="font-weight: 700; color: var(--accent-primary);">Processing prescription...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Medications Screen -->
    <div class="medications-screen" id="medicationsScreen">
        <div class="screen-header">
            <button class="back-btn" onclick="closeMedicationsScreen()">‚Üê Back</button>
            <div class="screen-title" id="medicationsTitle">Medications</div>
        </div>
        <div class="screen-content" id="medicationsContent"></div>
    </div>

    <!-- Reminders Screen -->
    <div class="reminders-screen" id="remindersScreen">
        <div class="screen-header">
            <button class="back-btn" onclick="closeRemindersScreen()">‚Üê Back</button>
            <div class="screen-title" id="remindersTitle">Reminders</div>
        </div>
        <div class="screen-content" id="remindersContent"></div>
    </div>

    <!-- AI Analysis Screen -->
    <div class="aiAnalysis-screen" id="aiAnalysisScreen">
        <div class="screen-header">
            <button class="back-btn" onclick="closeAIAnalysisScreen()">‚Üê Back</button>
            <div class="screen-title" id="aiAnalysisTitle">AI Insights</div>
        </div>
        <div class="screen-content" id="aiAnalysisContent"></div>
    </div>

    <!-- AI Chat Screen -->
<div class="aiAnalysis-screen" id="aiChatScreen">
    <div class="screen-header">
        <button class="back-btn" onclick="closeAIChatScreen()">‚Üê Back</button>
        <div class="screen-title">Voice Chat with AI Coach</div>
    </div>
    <div class="screen-content">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; padding: 40px 20px;">
            
            <!-- AI Avatar -->
            <div id="avatarContainer" style="position: relative; margin-bottom: 40px;">
                <img src="/static/images/lucid-origin_make_a_realistic_image_of_an_old_european_man_with_smile_and_light_beard_city_ma-0.jpg" 
                     alt="AI Coach" 
                     id="aiAvatar"
                     style="width: 200px; height: 200px; border-radius: 50%; object-fit: cover; border: 6px solid var(--accent-primary); box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3); transition: all 0.3s ease;">
                
                <!-- Listening Animation Ring -->
                <div id="listeningRing" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 220px; height: 220px; border: 4px solid var(--accent-primary); border-radius: 50%; opacity: 0; pointer-events: none;"></div>
            </div>
            
            <!-- Status Text -->
            <div id="voiceChatStatus" style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: 20px; text-align: center; min-height: 32px;">
                Tap to talk with your AI coach
            </div>
            
            <!-- Voice Button -->
            <button id="voiceChatBtn" onclick="toggleVoiceChat()" 
                    style="background: var(--accent-gradient); color: white; border: none; width: 120px; height: 120px; border-radius: 50%; font-size: 48px; cursor: pointer; box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; margin-bottom: 30px;">
                üé§
            </button>
            
            <!-- Disclaimer -->
            <div style="background: rgba(252, 129, 129, 0.1); border-left: 4px solid #fc8181; padding: 20px; border-radius: 12px; margin-top: 40px; max-width: 500px;">
                <div style="font-weight: 800; color: #c53030; margin-bottom: 8px; font-size: 14px;">‚ö†Ô∏è Important</div>
                <p style="color: #742a2a; font-size: 13px; font-weight: 600; line-height: 1.6; margin: 0;">This AI provides caregiving guidance only. It CANNOT diagnose medical conditions. Always consult healthcare professionals.</p>
            </div>
        </div>
    </div>
</div>

    <!-- Health Charts Screen -->
    <div class="health-screen" id="healthScreen">
        <div class="screen-header">
            <button class="back-btn" onclick="closeHealthScreen()">‚Üê Back</button>
            <div class="screen-title" id="healthTitle">Health Charts</div>
        </div>
        <div class="screen-content" id="healthContent">
            <!-- Medication Adherence Section -->
            <div id="adherenceSection" style="background: var(--bg-glass); backdrop-filter: blur(24px); padding: 20px; border-radius: 20px; box-shadow: var(--shadow-md); margin-bottom: 20px; border: 2px solid rgba(102, 126, 234, 0.15);">
                <div style="font-size: 20px; font-weight: 900; color: var(--text-primary); margin-bottom: 20px;">üíä Medication Adherence</div>
                <div id="adherenceStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <div style="background: var(--bg-primary); padding: 16px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 900; color: var(--accent-primary);" id="todayCount">-</div>
                        <div style="font-size: 13px; color: var(--text-secondary); font-weight: 700;">Today</div>
                    </div>
                    <div style="background: var(--bg-primary); padding: 16px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 900; color: #48bb78;" id="week7Count">-</div>
                        <div style="font-size: 13px; color: var(--text-secondary); font-weight: 700;">Last 7 Days</div>
                    </div>
                    <div style="background: var(--bg-primary); padding: 16px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 900; color: #9333ea;" id="totalCount">-</div>
                        <div style="font-size: 13px; color: var(--text-secondary); font-weight: 700;">Total</div>
                    </div>
                </div>
                <div id="adherenceHistory" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            
            <div style="background: var(--bg-glass); backdrop-filter: blur(24px); padding: 20px; border-radius: 20px; box-shadow: var(--shadow-md); margin-bottom: 20px; border: 2px solid rgba(102, 126, 234, 0.15);">
                <div style="font-size: 20px; font-weight: 900; color: var(--text-primary); margin-bottom: 20px;">üìà Blood Pressure</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <input type="number" id="bpSystolic" placeholder="Systolic (120)" min="70" max="200" style="padding: 14px; border-radius: 12px; border: 2px solid rgba(102, 126, 234, 0.2); background: var(--bg-primary); color: var(--text-primary); font-size: 15px; font-weight: 700;">
                    <input type="number" id="bpDiastolic" placeholder="Diastolic (80)" min="40" max="130" style="padding: 14px; border-radius: 12px; border: 2px solid rgba(102, 126, 234, 0.2); background: var(--bg-primary); color: var(--text-primary); font-size: 15px; font-weight: 700;">
                    <button class="btn btn-primary" onclick="addBPReading()" style="padding: 14px;">Add</button>
                </div>
                <div id="bpChart" style="width: 100%; min-height: 240px; background: var(--bg-primary); border-radius: 16px; padding: 16px;"></div>
            </div>
            <div style="background: var(--bg-glass); backdrop-filter: blur(24px); padding: 20px; border-radius: 20px; box-shadow: var(--shadow-md); margin-bottom: 20px; border: 2px solid rgba(102, 126, 234, 0.15);">
                <div style="font-size: 20px; font-weight: 900; color: var(--text-primary); margin-bottom: 20px;">ü©∏ Blood Sugar</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <input type="number" id="bloodSugar" placeholder="Reading (mg/dL)" min="40" max="400" style="padding: 14px; border-radius: 12px; border: 2px solid rgba(102, 126, 234, 0.2); background: var(--bg-primary); color: var(--text-primary); font-size: 15px; font-weight: 700;">
                    <select id="sugarContext" style="padding: 14px; border-radius: 12px; border: 2px solid rgba(102, 126, 234, 0.2); background: var(--bg-primary); color: var(--text-primary); font-size: 15px; font-weight: 700;">
                        <option value="fasting">Fasting</option>
                        <option value="before-meal">Before Meal</option>
                        <option value="after-meal">After Meal</option>
                        <option value="bedtime">Bedtime</option>
                    </select>
                    <button class="btn btn-primary" onclick="addSugarReading()" style="padding: 14px;">Add</button>
                </div>
                <div id="sugarChart" style="width: 100%; min-height: 240px; background: var(--bg-primary); border-radius: 16px; padding: 16px;"></div>
            </div>
        </div>
    </div>

    <!-- Calendar Screen -->
    <div class="health-screen" id="calendarScreen">
        <div class="screen-header">
            <button class="back-btn" onclick="closeCalendarScreen()">‚Üê Back</button>
            <div class="screen-title" id="calendarTitle">Calendar</div>
        </div>
        <div class="screen-content" id="calendarContent">
            <div style="background: var(--bg-glass); backdrop-filter: blur(24px); padding: 20px; border-radius: 20px; box-shadow: var(--shadow-md); margin-bottom: 20px; border: 2px solid rgba(102, 126, 234, 0.15);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                    <button style="background: var(--accent-gradient); color: white; border: none; padding: 10px 16px; border-radius: 12px; cursor: pointer; font-weight: 800; font-size: 14px; box-shadow: var(--shadow-sm);" onclick="previousMonth()">‚Üê Prev</button>
                    <div id="calendarMonth" style="font-size: 18px; font-weight: 900; color: var(--text-primary);">Loading...</div>
                    <button style="background: var(--accent-gradient); color: white; border: none; padding: 10px 16px; border-radius: 12px; cursor: pointer; font-weight: 800; font-size: 14px; box-shadow: var(--shadow-sm);" onclick="nextMonth()">Next ‚Üí</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 16px;">
                    <div style="text-align: center; font-size: 11px; font-weight: 800; color: var(--text-secondary); padding: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Sun</div>
                    <div style="text-align: center; font-size: 11px; font-weight: 800; color: var(--text-secondary); padding: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Mon</div>
                    <div style="text-align: center; font-size: 11px; font-weight: 800; color: var(--text-secondary); padding: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Tue</div>
                    <div style="text-align: center; font-size: 11px; font-weight: 800; color: var(--text-secondary); padding: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Wed</div>
                    <div style="text-align: center; font-size: 11px; font-weight: 800; color: var(--text-secondary); padding: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Thu</div>
                    <div style="text-align: center; font-size: 11px; font-weight: 800; color: var(--text-secondary); padding: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Fri</div>
                    <div style="text-align: center; font-size: 11px; font-weight: 800; color: var(--text-secondary); padding: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Sat</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 16px;" id="calendarDays"></div>
                <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; margin-top: 16px; font-size: 13px; font-weight: 700;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 14px; height: 14px; border-radius: 50%; background: #48bb78;"></div>
                        <span>Taken</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 14px; height: 14px; border-radius: 50%; background: #fc8181;"></div>
                        <span>Missed</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 18px; height: 18px; border-radius: 50%; background: #fbbf24;"></div>
                        <span>Pending</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Brain Games Screen -->
<div class="aiAnalysis-screen" id="brainGamesScreen">
    <div class="screen-header">
        <button class="back-btn" onclick="closeBrainGamesScreen()">‚Üê Back</button>
        <div class="screen-title">üß† Brain Games</div>
    </div>
    <div class="screen-content">
        <!-- Game Selection -->
        <div id="gameSelection">
            <div style="text-align: center; margin-bottom: 32px;">
                <div style="font-size: 72px; margin-bottom: 16px;">üß†</div>
                <h2 style="font-size: 28px; font-weight: 900; color: var(--text-primary); margin-bottom: 12px;">Choose a Game</h2>
                <p style="font-size: 16px; color: var(--text-secondary); font-weight: 600;">Fun exercises to keep your mind active</p>
            </div>
            
            <div style="display: grid; gap: 20px; max-width: 600px; margin: 0 auto;">
                <div class="feature-btn" onclick="startGame('math')" style="padding: 32px; border: 3px solid var(--accent-primary);">
                    <div class="feature-btn-icon" style="font-size: 56px;">üå∏</div>
                    <div class="feature-btn-label" style="font-size: 22px;">Math Garden</div>
                    <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px; font-weight: 600;">Simple addition & subtraction</div>
                </div>
                
                <div class="feature-btn" onclick="startGame('words')" style="padding: 32px; border: 3px solid #48bb78;">
                    <div class="feature-btn-icon" style="font-size: 56px;">üí¨</div>
                    <div class="feature-btn-label" style="font-size: 22px;">Word Friends</div>
                    <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px; font-weight: 600;">Say related words together</div>
                </div>
                
                <div class="feature-btn" onclick="startGame('memory')" style="padding: 32px; border: 3px solid #f59e0b;">
                    <div class="feature-btn-icon" style="font-size: 56px;">üéØ</div>
                    <div class="feature-btn-label" style="font-size: 22px;">Remember & Repeat</div>
                    <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px; font-weight: 600;">Practice your memory</div>
                </div>
            </div>
        </div>
        
        <!-- Game Play Area -->
        <div id="gamePlayArea" style="display: none;">
            <div style="background: var(--bg-card); border-radius: 24px; padding: 32px; box-shadow: var(--shadow-lg); text-align: center;">
                <div id="gameTitle" style="font-size: 28px; font-weight: 900; margin-bottom: 24px; color: var(--accent-primary);"></div>
                
                <!-- Score Display -->
                <div style="display: flex; justify-content: center; gap: 24px; margin-bottom: 32px; flex-wrap: wrap;">
                    <div style="background: linear-gradient(135deg, #48bb78, #38a169); color: white; padding: 16px 24px; border-radius: 16px; box-shadow: var(--shadow-sm);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">‚úì Correct</div>
                        <div id="correctScore" style="font-size: 32px; font-weight: 900;">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 16px 24px; border-radius: 16px; box-shadow: var(--shadow-sm);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">üìù Total</div>
                        <div id="totalScore" style="font-size: 32px; font-weight: 900;">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 16px 24px; border-radius: 16px; box-shadow: var(--shadow-sm);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">‚è±Ô∏è Time</div>
                        <div id="gameTimer" style="font-size: 32px; font-weight: 900;">0:00</div>
                    </div>
                </div>
                
                <!-- Question Display -->
                <div id="questionDisplay" style="background: var(--bg-primary); padding: 48px 32px; border-radius: 20px; margin-bottom: 32px; min-height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <div id="questionEmoji" style="font-size: 64px; margin-bottom: 24px;">üå∏</div>
                    <div id="questionText" style="font-size: 32px; font-weight: 900; color: var(--text-primary); margin-bottom: 24px;"></div>
                </div>
                
                <!-- Answer Input -->
                <div id="answerInput" style="margin-bottom: 24px;"></div>
                
                <!-- Voice Status -->
                <div id="gameVoiceStatus" style="display: none; margin-top: 16px; padding: 12px 20px; background: rgba(102, 126, 234, 0.1); border-radius: 12px; text-align: center; font-weight: 700; color: var(--accent-primary);">
                    üé§ Listening...
                </div>
                
                <!-- Controls -->
                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="endGame()" style="padding: 14px 28px; margin: 0;">End Game</button>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
// ==================== CONFIG ====================
const API_BASE_URL = 'https://loveuad.com';

let currentUser = null;
let suggestedMedications = [];
let alarmCheckInterval = null;
let activeAlarm = null;
let alarmAudio = null;
let currentCalendarMonth = new Date();
let cameraStream = null;
let userTier = 'premium'; // 'free' or 'premium'
let isAndroid = false;
let medicationsCache = [];

// Check URL params for tier on load
window.addEventListener('DOMContentLoaded', function() {
    userTier = 'premium';
    
    // Detect Android
    isAndroid = /android/i.test(navigator.userAgent);
});

// ==================== API ====================
async function apiCall(endpoint, method = 'GET', data = null) {
    try {
        const options = {
            method, 
            headers: {'Content-Type': 'application/json'},
            timeout: 100
        };
        if (data) options.body = JSON.stringify(data);
        
        const response = await fetch(API_BASE_URL + endpoint, options);
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Backend offline or not responding with JSON');
        }
        
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'API failed');
        return result;
    } catch (error) {
        console.error('API Error:', error);
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            throw new Error('Cannot connect to backend - Check if Python server is running');
        }
        throw error;
    }
}

function hashCode(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return Math.abs(hash).toString(16);
}

// Compute SHA-256 hex in browser as a fallback to match server-side hashing
async function sha256Hex(message) {
    try {
        const msgBuffer = new TextEncoder().encode(message.replace(/-/g, '').toUpperCase());
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    } catch (e) {
        console.warn('sha256Hex failed, falling back to simple hashCode:', e);
        return hashCode(message);
    }
}
function showToast(message) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 4000);
}

function openModal(modalId) {
    document.getElementById(modalId).classList.add("active");
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove("active");
    if (modalId === "patientLoginModal") {
        document.getElementById("loginCode").value = "";
    }
}

function updateConnectionStatus(isOnline) {
    const statusDiv = document.getElementById('connectionStatus');
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');
    
    if (isOnline) {
        statusDiv.className = 'connection-status online';
        statusIcon.textContent = '‚óè';
        statusText.textContent = 'ONLINE';
    } else {
        statusDiv.className = 'connection-status offline';
        statusIcon.textContent = '‚óè';
        statusText.textContent = 'OFFLINE';
    }
}

// ==================== TIER MANAGEMENT ====================
function renderDashboardFeatures() {
    const featureGrid = document.getElementById('featureGrid');
    
    if (currentUser.role === 'patient') {
        // SIMPLE VIEW FOR PATIENTS - Only essential features with LARGE buttons
        if (userTier === 'premium') {
            featureGrid.innerHTML = `
                <div class="feature-btn patient-btn" id="scanBtn" onclick="openCamera()">
                    <div class="feature-btn-icon">üì∏</div>
                    <div class="feature-btn-label">Camera</div>
                </div>
                <div class="feature-btn patient-btn" onclick="viewReminders()">
                    <div class="feature-btn-icon">‚è∞</div>
                    <div class="feature-btn-label">Reminders</div>
                </div>
                <div class="feature-btn patient-btn" onclick="viewMedications()">
                    <div class="feature-btn-icon"> </div>
                    <div class="feature-btn-label">Medicines</div>
                </div>
            <div class="feature-btn patient-btn" onclick="startBrainGames()">
            <div class="feature-btn-icon">üß†</div>
            <div class="feature-btn-label">Brain Games</div>
        </div>
            `;
        } else {
            // Free tier patients: No camera
            featureGrid.innerHTML = `
                <div class="feature-btn patient-btn" onclick="viewReminders()">
                    <div class="feature-btn-icon">‚è∞</div>
                    <div class="feature-btn-label">Reminders</div>
                </div>
                <div class="feature-btn patient-btn" onclick="viewMedications()">
                    <div class="feature-btn-icon"> </div>
                    <div class="feature-btn-label">Medicines</div>
                </div>
            `;
        }
    } else {
        // FULL VIEW FOR CAREGIVERS - All features
        if (userTier === 'premium') {
            featureGrid.innerHTML = `
                <div class="feature-btn" id="scanBtn" onclick="openCamera()">
                    <div class="feature-btn-icon">üì∏</div>
                    <div class="feature-btn-label">Scan Rx</div>
                </div>
                <div class="feature-btn" onclick="viewMedications()">
                    <div class="feature-btn-icon">üíä</div>
                    <div class="feature-btn-label">Medications</div>
                </div>
                <div class="feature-btn" onclick="viewReminders()">
                    <div class="feature-btn-icon">‚è∞</div>
                    <div class="feature-btn-label">Reminders</div>
                </div>
                <div class="feature-btn" onclick="viewAIChat()">
                    <div class="feature-btn-icon">üí¨</div>
                    <div class="feature-btn-label">AI Chat</div>
                </div>
                <div class="feature-btn" onclick="viewHealth()">
                    <div class="feature-btn-icon">üìä</div>
                    <div class="feature-btn-label">Health</div>
                </div>
                <div class="feature-btn" id="testAlarmBtn" onclick="testAlarm()" style="display: none; border: 4px solid #48bb78;">
                    <div class="feature-btn-icon">üîî</div>
                    <div class="feature-btn-label" style="color: #276749;">Test Alarm</div>
                </div>
            `;
        } else {
            // Free tier caregivers: Basic features
            featureGrid.innerHTML = `
                <div class="feature-btn" onclick="viewMedications()">
                    <div class="feature-btn-icon">üíä</div>
                    <div class="feature-btn-label">Medications</div>
                </div>
                <div class="feature-btn" onclick="viewReminders()">
                    <div class="feature-btn-icon">‚è∞</div>
                    <div class="feature-btn-label">Reminders</div>
                </div>
                <div class="feature-btn" id="testAlarmBtn" onclick="testAlarm()" style="display: none; border: 4px solid #48bb78;">
                    <div class="feature-btn-icon">üîî</div>
                    <div class="feature-btn-label" style="color: #276749;">Test Alarm</div>
                </div>
            `;
        }
    }
}

async function fetchMedicationsFromDatabase() {
    if (!currentUser) return [];
    
    const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0].codeHash;
    
    try {
        const result = await apiCall(`/api/medications/${codeHash}`);
        
        if (result.success && result.medications) {
            medicationsCache = result.medications;
            console.log('‚úÖ Medications loaded from database:', medicationsCache.length, medicationsCache);
            return medicationsCache;
        } else {
            medicationsCache = [];
            console.log('‚ö†Ô∏è No medications found in database');
            return [];
        }
    } catch (error) {
        console.error('‚ùå Failed to fetch medications:', error);
        return medicationsCache;
    }
}

function showUpgradeModal() {
    alert('‚ú® Premium Features Include:\n\nüì∏ Scan Prescriptions with Camera\nü§ñ AI Health Insights\nüìä Blood Pressure & Sugar Tracking\n\nUpgrade to unlock these features!');
}

// ==================== ROLE SELECTION ====================
// ==================== ROLE SELECTION ====================
function selectRole(role) {
    if (role === 'patient') {
        openModal("patientOptionsModal");
    } else if (role === 'caregiver') {
        openModal("caregiverModal");
    }
}

function selectPatientOption(option) {
    closeModal("patientOptionsModal");
    if (option === 'new') {
        openModal("patientModal");
    } else if (option === 'existing') {
        openModal("patientLoginModal");
    }
}

// ==================== LOGIN ====================
async function loginExistingPatient() {
    const inputElement = document.getElementById("loginCode");
    
    // 1. Clean the input: remove dashes and convert to uppercase
    const code = inputElement.value.trim().toUpperCase().replace(/-/g, '');

    if (!code) return showToast("Please enter your patient code");
    
    // 2. ADD VALIDATION: Ensure the cleaned code is exactly 17 characters long
    if (code.length !== 17) {
        return showToast("‚ùå Patient code must be 17 characters long (excluding dashes).");
    }
    
    showToast("üîÑ Verifying code...");
    
    try {
        // The cleaned 'code' is sent to the API
        const result = await apiCall('/api/patient/login', 'POST', {patientCode: code});
        
        if (result.success && result.patient) {
            // Prefer server-provided codeHash (exact SHA-256 used by backend). Fallback to browser sha256 if missing.
            // NOTE: The code variable is already the clean 17-char version.
            const serverCodeHash = result.codeHash || (result.patient && result.patient.codeHash) || await sha256Hex(code);

            currentUser = {
                role: "patient",
                displayName: result.patient.firstName, // Backend returns firstName, we treat it as displayName
                age: result.patient.age,
                gender: result.patient.gender,
                code: code, // Use the cleaned code here
                codeHash: serverCodeHash,
                tier: result.patient.tier || userTier
            };
            
            userTier = result.patient.tier || userTier;
            localStorage.setItem('userTier', userTier);
            localStorage.setItem("currentUser", JSON.stringify(currentUser));
            showToast("‚úì Login successful!");
            closeModal("patientLoginModal");
            goToDashboard();
            await loadMedicationsFromDB();
        } else {
            showToast("‚ùå Invalid patient code");
        }
    } catch (error) {
        console.error('Login error:', error);
        if (error.message.includes('Backend offline') || error.message.includes('Cannot connect')) {
            showToast("‚ö†Ô∏è Backend offline - Start Python server first");
        } else {
            showToast("‚ùå Login failed: " + error.message);
        }
    }
}

async function loadMedicationsFromDB() {
    if (!currentUser) return;
    
    const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0].codeHash;
    const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
    
    console.log('Loading medications - Role:', currentUser.role, 'CodeHash:', codeHash, 'PatientCode:', patientCode);
    
    if (!codeHash) {
        console.error('No codeHash found!');
        return;
    }
    
    try {
        const result = await apiCall(`/api/medications/${codeHash}`);
        console.log('Medications API response:', result);
        if (result.success && result.medications) {
            localStorage.setItem("medications_" + patientCode, JSON.stringify(result.medications));
            console.log('Saved medications to localStorage:', result.medications);
        }
    } catch (error) {
        console.error('Failed to load medications:', error);
    }
}

// ==================== REGISTRATION ====================
async function registerPatient() {
    const displayName = document.getElementById("displayName").value.trim();
    const age = document.getElementById("patientAge").value.trim();
    const gender = document.getElementById("patientGender").value;
    const phoneNumber = document.getElementById("phoneNumber").value.trim();
    const termsAccepted = document.getElementById("termsAccept").checked;
    
    if (!displayName) return showToast("Please enter your display name");
    if (!age || age < 1 || age > 120) return showToast("Please enter valid age");
    if (!gender) return showToast("Please select gender");
    if (!termsAccepted) return showToast("Please accept terms");
    
    showToast("üîÑ Creating your profile...");
    
    try {
        const result = await apiCall('/api/patient/register', 'POST', {
            firstName: displayName,  // Send display name as firstName
            lastName: 'k',           // Send single space as lastName
            age: parseInt(age), 
            gender, 
            phoneNumber, 
            acceptedTerms: termsAccepted,
            tier: userTier
        });
        
        if (result.success && result.patientCode) {
            const patientCode = result.patientCode;
            const serverCodeHash = result.codeHash || await sha256Hex(patientCode);

            currentUser = {
                role: "patient", 
                displayName: displayName,
                age: parseInt(age), 
                gender,
                code: patientCode, 
                codeHash: serverCodeHash,
                tier: userTier
            };
            
            localStorage.setItem("currentUser", JSON.stringify(currentUser));
            localStorage.setItem("medications_" + patientCode, JSON.stringify([]));
            localStorage.setItem('userTier', userTier);
            
            document.getElementById("patientCode").textContent = patientCode;
            closeModal("patientModal");
            openModal("codeModal");
            
            showToast("‚úì Profile created!");
        } else {
            showToast("‚ùå Registration failed");
        }
    } catch (error) {
        console.error('Registration error:', error);
        if (error.message.includes('Backend offline') || error.message.includes('Cannot connect')) {
            showToast("‚ö†Ô∏è Backend offline - Start Python server: python app.py");
        } else {
            showToast("‚ùå Registration failed: " + error.message);
        }
    }
}

// ==================== CAREGIVER ====================
async function connectCaregiver() {
    const patientCode = document.getElementById("caregiverCode").value.trim().toUpperCase();
    
    if (!patientCode) return showToast("Please enter patient code");
    
    showToast("üîÑ Logging in...");
    
    try {
        const loginResult = await apiCall('/api/patient/login', 'POST', {patientCode: patientCode});
        
        console.log('Login result:', loginResult);

        if (loginResult.success && loginResult.patient) {
            // Use server-provided codeHash
            const serverCodeHash = loginResult.codeHash || (loginResult.patient && loginResult.patient.codeHash) || await sha256Hex(patientCode);
            
            console.log('Creating caregiver user with codeHash:', serverCodeHash);

            currentUser = {
                role: "caregiver",
                patients: [{
                    code: patientCode,
                    codeHash: serverCodeHash,
                    displayName: loginResult.patient.firstName,
                    age: loginResult.patient.age,
                    gender: loginResult.patient.gender,
                    tier: loginResult.patient.tier || 'free'
                }],
                tier: loginResult.patient.tier || 'free'
            };
            
            console.log('Current user set:', currentUser);
            
            userTier = loginResult.patient.tier || 'free';
            localStorage.setItem('userTier', userTier);
            localStorage.setItem("currentUser", JSON.stringify(currentUser));
            
            showToast("‚úì Login successful!");
            closeModal("caregiverModal");
            goToDashboard();
            await loadMedicationsFromDB();
        } else {
            console.error('Login failed:', loginResult);
            showToast("‚ùå Invalid patient code");
        }
    } catch (error) {
        console.error('Login error:', error);
        if (error.message.includes('Backend offline') || error.message.includes('Cannot connect')) {
            showToast("‚ö†Ô∏è Backend offline - Start Python server first");
        } else {
            showToast("‚ùå Login failed: " + error.message);
        }
    }
}

// ==================== DASHBOARD ====================
function goToDashboard() {
    closeModal("codeModal");
    document.getElementById("homeScreen").style.display = "none";
    document.getElementById("dashboardScreen").classList.add("active");
    
    navigationStack = ['home', 'dashboard'];
    pushNavigation('dashboard');
    
    // CRITICAL: Initialize audio on user interaction (required for mobile)
    initializeAudioContext();
    requestPushPermission();
    
    const avatar = document.getElementById("userAvatar");
    const userName = document.getElementById("userName");
    const userRole = document.getElementById("userRole");
    const tierBadge = document.getElementById("tierBadge");
    
    // Render features based on tier
    renderDashboardFeatures();
    
    // FEATURE 1: Check for survey eligibility (caregivers only)
    setTimeout(() => checkAndShowSurveyBanner(), 2000);  // Delay 2s to avoid overwhelming UI
    
    if (currentUser.role === "patient") {
        avatar.textContent = currentUser.displayName[0].toUpperCase();
        userName.textContent = currentUser.displayName;
        userRole.textContent = "Patient";
        
        if (userTier === 'premium') {
            tierBadge.innerHTML = '<span class="premium-badge">PREMIUM</span>';
            const testAlarmBtn = document.getElementById("testAlarmBtn");
            if (testAlarmBtn) testAlarmBtn.style.display = "block";
        }
        
        startAlarmChecker();
    } else {
        avatar.textContent = "üë®‚Äç‚öïÔ∏è";
        userName.textContent = currentUser.patients[0].displayName;
        userRole.textContent = `Caregiver`;
        
        if (userTier === 'premium') {
            tierBadge.innerHTML = '<span class="premium-badge">PREMIUM</span>';
        }
        
        document.getElementById("patientIdDisplay").style.display = "block";
        document.getElementById("patientIdCode").textContent = currentUser.patients[0].code;
        
        const testAlarmBtn = document.getElementById("testAlarmBtn");
        if (testAlarmBtn) testAlarmBtn.style.display = "block";
    }
    
    updateAIInsightsBadge();
    
    // Show Android alarm helper if on Android and has medications
    if (isAndroid) {
        const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
        const medications = JSON.parse(localStorage.getItem("medications_" + patientCode) || "[]");
        const androidHelper = document.getElementById('androidAlarmHelper');
        const webAlarmWarning = document.getElementById('webAlarmWarning');
        
        if (androidHelper && medications.length > 0) {
            androidHelper.style.display = 'block';
            // Hide web alarm warning for Android users since they have native option
            if (webAlarmWarning) {
                webAlarmWarning.style.display = 'none';
            }
        }
    }
}

async function updateAIInsightsBadge() {
    if (userTier !== 'premium') return;
    
    const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
    const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0].codeHash;
    
    let hasAIInsights = false;
    try {
        const result = await apiCall(`/api/health/records/${codeHash}`);
        if (result.success && result.records && result.records.length > 0) {
            const aiRecords = result.records.filter(r => r.recordType === 'ai_analysis');
            if (aiRecords.length > 0) {
                hasAIInsights = true;
                const latestInsights = aiRecords[0].metadata.aiInsights;
                if (latestInsights) {
                    localStorage.setItem('lastAIInsights_' + patientCode, JSON.stringify(latestInsights));
                }
            }
        }
    } catch (error) {
        console.error('Failed to check AI insights from database:', error);
        hasAIInsights = localStorage.getItem('lastAIInsights_' + patientCode) !== null;
    }
    
    const aiButtons = document.querySelectorAll('.feature-btn');
    aiButtons.forEach(btn => {
        if (btn.textContent.includes('AI Insights')) {
            const existingBadge = btn.querySelector('.ai-badge');
            if (existingBadge) existingBadge.remove();
            
            if (hasAIInsights) {
                const badge = document.createElement('div');
                badge.className = 'ai-badge';
                badge.style.cssText = 'position: absolute; top: 12px; right: 12px; background: var(--danger-gradient); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 900; box-shadow: var(--shadow-md); animation: pulse 2s infinite;';
                badge.textContent = '!';
                btn.style.position = 'relative';
                btn.appendChild(badge);
            }
        }
    });
}

function copyCode() {
    const code = document.getElementById("patientCode").textContent;
    navigator.clipboard.writeText(code);
    showToast("‚úì Copied!");
}

function toggleDarkMode() {
    document.body.classList.toggle("dark-mode");
    const isDark = document.body.classList.contains("dark-mode");
    localStorage.setItem("darkMode", isDark ? "enabled" : "disabled");
    document.querySelector(".dark-mode-toggle").textContent = isDark ? "‚òÄÔ∏è" : "üåô";
    showToast(isDark ? "üåô Dark mode" : "‚òÄÔ∏è Light mode");
}

// ==================== SETTINGS ====================
function openSettings() {
    if (!currentUser) return;
    
    document.getElementById("settingsRole").textContent = currentUser.role === "patient" ? "Patient" : "Caregiver";
    document.getElementById("settingsTier").textContent = userTier === 'premium' ? 'Premium ‚ú®' : 'Free';
    
const tierSection = document.getElementById('settingsTierSection');
if (tierSection) {
    tierSection.style.display = 'none';
}
    
    if (currentUser.role === "patient") {
        document.getElementById("settingsName").textContent = currentUser.displayName;
        
        if (currentUser.age && currentUser.gender) {
            document.getElementById("settingsAgeGenderSection").style.display = "block";
            document.getElementById("settingsAgeGender").textContent = `${currentUser.age} years old, ${currentUser.gender}`;
        }
        
        document.getElementById("settingsCodeSection").style.display = "block";
        document.getElementById("settingsCode").textContent = currentUser.code;
    } else {
        document.getElementById("settingsName").textContent = "Caregiver for " + currentUser.patients[0].displayName;
        document.getElementById("settingsAgeGenderSection").style.display = "none";
        document.getElementById("settingsCodeSection").style.display = "none";
    }
    
    openModal("settingsModal");
}

function copyCodeFromSettings() {
    if (currentUser && currentUser.code) {
        navigator.clipboard.writeText(currentUser.code);
        showToast("‚úì Code copied!");
    }
}

function logoutUser() {
    if (confirm("Are you sure you want to logout?")) {
        localStorage.removeItem("currentUser");
        currentUser = null;
        if (alarmCheckInterval) clearInterval(alarmCheckInterval);
        closeModal("settingsModal");
        document.getElementById("dashboardScreen").classList.remove("active");
        document.getElementById("homeScreen").style.display = "flex";
        showToast("‚úì Logged out");
    }
}

async function confirmReset() {
    if (confirm("‚ö†Ô∏è RESET APP?\n\nThis will:\n‚Ä¢ Clear all local app data\n‚Ä¢ Stop ALL medication alarms & Twilio calls\n‚Ä¢ Keep your patient code active\n‚Ä¢ You can login again with your code\n\nAre you sure?")) {
        
        showToast("üîÑ Resetting app and stopping alarms...");
        
        // Get codeHash before clearing localStorage
        const codeHash = currentUser?.codeHash || (currentUser?.patients?.[0]?.codeHash);
        
        if (codeHash) {
            try {
                // Deactivate all alarms in database (stops Twilio calls)
                const result = await apiCall('/api/alarms/deactivate-all', 'POST', {
                    codeHash: codeHash
                });
                
                if (result.success) {
                    showToast("‚úì All alarms stopped");
                } else {
                    showToast("‚ö†Ô∏è Could not stop backend alarms");
                }
            } catch (error) {
                console.error('Alarm deactivation error:', error);
                showToast("‚ö†Ô∏è Backend offline - alarms may still ring");
            }
        }
        
        // Stop local alarm checker
        if (alarmCheckInterval) {
            clearInterval(alarmCheckInterval);
            alarmCheckInterval = null;
        }
        
        // Clear ALL local data
        localStorage.clear();
        
        // Reload to login screen
        showToast("‚úì App reset complete");
        setTimeout(() => location.reload(), 1000);
    }
}
// ==================== CAMERA + OCR ====================
function openCamera() {
    if (userTier !== 'premium') {
        showUpgradeModal();
        return;
    }

    // Hide home if visible
    const home = document.getElementById("homeScreen");
    if (home) home.style.display = "none";

    document.getElementById("dashboardScreen").classList.remove("active");
    document.getElementById("cameraScreen").classList.add("active");
    pushNavigation('camera');

    // FORCE file upload in mobile apps
    showFileUploadOption();
}

function closeCameraBack() {
    // Safely stop camera (no error if stream not started)
    try {
        stopCamera();
    } catch (e) {
        console.warn('stopCamera() failed:', e);
    }

    // Hide home (we're going back to dashboard, not home)
    const home = document.getElementById("homeScreen");
    if (home) home.style.display = "none";

    // Hide all app screens
    document.querySelectorAll(
        '.camera-screen, .medications-screen, .reminders-screen, .health-screen, .aiAnalysis-screen'
    ).forEach(el => el.classList.remove('active'));

    // Show dashboard
    document.getElementById("dashboardScreen").classList.add("active");
    currentScreen = 'dashboard';

    // Update navigation stack
    popNavigation();
}

async function startCamera() {
    try {
        const video = document.getElementById('cameraVideo');

        cameraStream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'environment',
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            }
        });

        video.srcObject = cameraStream;
        video.style.display = 'block';

        // CRITICAL: Start playing the video
        await video.play();

        document.getElementById('startCameraBtn').style.display = 'none';
        document.getElementById('captureBtn').style.display = 'block';
        document.getElementById('stopCameraBtn').style.display = 'block';

        showToast("üì∑ Camera ready");
    } catch (error) {
        console.error('Camera error:', error);
        showToast("‚ùå Camera access denied");
    }
}

function showFileUploadOption() {
    const cameraControls = document.getElementById('cameraControls');
    cameraControls.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <p style="margin-bottom: 20px; color: var(--text-secondary); font-weight: 600; font-size: 18px;">üì∏ Take or Upload Photo</p>
            <input type="file" accept="image/*" capture="environment" id="fileUpload" style="display: none;" onchange="handleFileUpload(event)">
            <label for="fileUpload" class="btn btn-primary" style="display: inline-block; cursor: pointer; padding: 24px;">üì∑ Take/Choose Photo</label>
        </div>
    `;
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const imageData = e.target.result;
        document.getElementById('processingStatus').style.display = 'block';
        showToast("üîÑ Processing.");

        const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
        const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0].codeHash;
        const patientAge = currentUser.role === "patient" ? currentUser.age : currentUser.patients[0].age;
        const patientGender = currentUser.role === "patient" ? currentUser.gender : currentUser.patients[0].gender;

        apiCall('/api/health/ocr', 'POST', {
            imageData: imageData,
            patientAge: patientAge,
            patientGender: patientGender
        }).then(result => {
            document.getElementById('processingStatus').style.display = 'none';

            if (result.success && result.ocrResult) {
                const meds = result.ocrResult.extracted_data?.medications || [];

                if (meds.length > 0) {
                    showMedicationSchedule(meds);

                    if (result.ocrResult.ai_insights && result.ocrResult.ai_insights.enabled) {
                        localStorage.setItem('lastAIInsights_' + patientCode, JSON.stringify(result.ocrResult.ai_insights));

                        apiCall('/api/health/record', 'POST', {
                            codeHash: codeHash,
                            recordType: 'ai_analysis',
                            ocrText: result.ocrResult.raw_text || '',
                            extractedData: result.ocrResult.extracted_data || {},
                            aiInsights: result.ocrResult.ai_insights,
                            notes: 'AI analysis from prescription scan',
                            imageId: Date.now().toString()
                        }).then(() => {
                            console.log('‚úÖ AI insights saved to database');
                            updateAIInsightsBadge();
                        }).catch(dbError => {
                            console.error('Failed to save AI insights to database:', dbError);
                        });
                    }

                    showToast("‚úì Prescription scanned successfully!");
                    showToast("‚úì Processed!");
                } else {
                    showToast("‚ö†Ô∏è No medications found");
                }
            }
        }).catch(error => {
            document.getElementById('processingStatus').style.display = 'none';
            showToast("‚ùå Failed");
        });
    };
    reader.readAsDataURL(file);
}

function stopCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }

    const video = document.getElementById('cameraVideo');
    video.style.display = 'none';

    document.getElementById('startCameraBtn').style.display = 'block';
    document.getElementById('captureBtn').style.display = 'none';
    document.getElementById('stopCameraBtn').style.display = 'none';
}

async function capturePhoto() {
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('cameraCanvas');
    const context = canvas.getContext('2d');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);

    const imageData = canvas.toDataURL('image/jpeg', 0.9);

    stopCamera();
    document.getElementById('processingStatus').style.display = 'block';
    showToast("üîÑ Processing prescription.");

    const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
    const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0].codeHash;
    const patientAge = currentUser.role === "patient" ? currentUser.age : currentUser.patients[0].age;
    const patientGender = currentUser.role === "patient" ? currentUser.gender : currentUser.patients[0].gender;

    try {
        const result = await apiCall('/api/health/ocr', 'POST', {
            imageData: imageData,
            patientAge: patientAge,
            patientGender: patientGender
        });

        document.getElementById('processingStatus').style.display = 'none';

        if (result.success && result.ocrResult) {
            if (result.ocrResult.error) {
                const error = result.ocrResult.error;
                if (error.includes('API key')) {
                    showToast("‚ùå OpenAI API key not configured in backend!");
                    alert("‚ö†Ô∏è SETUP REQUIRED:\n\n1. Get OpenAI API key from openai.com\n2. Set environment variable:\n   export OPENAI_API_KEY=sk-...\n3. Restart Python server");
                } else if (error.includes('API error')) {
                    showToast("‚ùå OpenAI API error - Check console");
                } else {
                    showToast("‚ùå OCR error: " + error);
                }
                return;
            }

            const meds = result.ocrResult.extracted_data?.medications || [];
            const appointment = result.ocrResult.extracted_data?.appointment;

            // Handle appointment if found
            console.log('üîç Appointment data from backend:', appointment);
            if (appointment && appointment.found) {
                console.log('‚úÖ Appointment found, showing dialog');
                showAppointmentFound(appointment, codeHash);
            } else {
                console.log('‚ùå No appointment found in scan');
            }

            if (meds.length > 0) {
                showMedicationSchedule(meds);

                if (result.ocrResult.ai_insights && result.ocrResult.ai_insights.enabled) {
                    localStorage.setItem('lastAIInsights_' + patientCode, JSON.stringify(result.ocrResult.ai_insights));

                    apiCall('/api/health/record', 'POST', {
                        codeHash: codeHash,
                        recordType: 'ai_analysis',
                        ocrText: result.ocrResult.raw_text || '',
                        extractedData: result.ocrResult.extracted_data || {},
                        aiInsights: result.ocrResult.ai_insights,
                        notes: 'AI analysis from prescription scan',
                        imageId: Date.now().toString()
                    }).then(() => {
                        console.log('‚úÖ AI insights saved to database');
                        updateAIInsightsBadge();
                    }).catch(dbError => {
                        console.error('Failed to save AI insights to database:', dbError);
                    });
                }

                showToast("‚úì Prescription scanned successfully!");
            } else {
                showToast("‚ö†Ô∏è No medications found");
            }
        }
    } catch (error) {
        document.getElementById('processingStatus').style.display = 'none';
        showToast("‚ùå Failed");
    }
}


function showAppointmentFound(appointment, codeHash) {
    console.log('üìÖ showAppointmentFound called with:', appointment);
    
    // Show appointment notification
    const appointmentDate = new Date(appointment.date);
    const formattedDate = appointmentDate.toLocaleDateString('en-GB', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    console.log('üìÖ Formatted date:', formattedDate);
    
    const message = `üìÖ Appointment Found!\n\n${appointment.type}\n${formattedDate}\n\nWould you like to add this to your reminders?`;
    
    if (confirm(message)) {
        const calendarEvent = {
            title: appointment.type,
            date: appointment.date,
            type: 'appointment',
            time: '10:00', // Default time
            notes: 'Extracted from scanned document'
        };
        
        // Save to database
        apiCall('/api/health/appointments/add', 'POST', {
            codeHash: codeHash,
            appointment: calendarEvent
        }).then(() => {
            console.log('‚úÖ Appointment saved to database:', calendarEvent);
            showToast(`‚úì ${appointment.type} added to reminders for ${formattedDate}`);
            
            // Refresh reminders if it's open
            if (currentScreen === 'reminders') {
                loadReminders();
            }
        }).catch(error => {
            console.error('Failed to save appointment:', error);
            showToast('‚ö†Ô∏è Could not save appointment');
        });
    } else {
        showToast(`üìÖ Appointment found: ${formattedDate} - You can add it manually later`);
    }
}

function showMedicationSchedule(medications) {
    suggestedMedications = medications;
    const container = document.getElementById("medScheduleContainer");
    
    let html = '<h4 style="color: var(--accent-primary); margin-bottom: 20px; font-weight: 900; font-size: 20px;">üíä Medications</h4>';
    
    medications.forEach((med, medIndex) => {
        html += `<div style="background: var(--bg-primary); padding: 24px; border-radius: 20px; margin-bottom: 20px; border-left: 6px solid var(--accent-primary);">
            <div style="font-weight: 900; font-size: 20px; margin-bottom: 10px; color: var(--text-primary);">${med.name}</div>
            <div style="color: var(--text-secondary); font-size: 15px; margin-bottom: 16px; font-weight: 700;">${med.dosage} ‚Ä¢ ${med.frequency}x daily</div>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                ${med.times.map((time, timeIndex) => 
                    `<input type="time" value="${time}" onchange="updateMedTime(${medIndex}, ${timeIndex}, this.value)" style="border: 2px solid var(--accent-primary); padding: 12px; border-radius: 12px; font-weight: 800; background: var(--bg-secondary); color: var(--text-primary);">`
                ).join("")}
            </div>
        </div>`;
    });
    
    container.innerHTML = html;
    
    // Show Android native alarm option if on Android
    const androidOption = document.getElementById('androidAlarmOption');
    if (isAndroid) {
        androidOption.style.display = 'block';
    } else {
        androidOption.style.display = 'none';
    }
    
    openModal("medScheduleModal");
}

function updateMedTime(medIndex, timeIndex, newTime) {
    suggestedMedications[medIndex].times[timeIndex] = newTime;
}

// ==================== ANDROID NATIVE ALARMS ====================
function generateAndroidAlarmIntent(time, medicationName) {
    // Parse time (HH:MM format)
    const [hours, minutes] = time.split(':');
    
    // Create alarm message
    const message = `${medicationName} - Take medication`;
    
    // Generate Android AlarmClock intent
    const intentUrl = `intent:#Intent;action=android.intent.action.SET_ALARM;i.android.intent.extra.alarm.HOUR=${parseInt(hours)};i.android.intent.extra.alarm.MINUTES=${parseInt(minutes)};S.android.intent.extra.alarm.MESSAGE=${encodeURIComponent(message)};b.android.intent.extra.alarm.SKIP_UI=false;end`;
    
    return intentUrl;
}
function setNativeAndroidAlarms() {
    if (!isAndroid) {
        showToast("‚ö†Ô∏è Native alarms only available on Android");
        return;
    }
    
    let alarmsSet = 0;
    const totalAlarms = suggestedMedications.reduce((sum, med) => sum + med.times.length, 0);
    
    // Create a list of all alarms to set
    const alarmIntents = [];
    suggestedMedications.forEach((med, medIndex) => {
        med.times.forEach((time, timeIndex) => {
            const intentUrl = generateAndroidAlarmIntent(time, med.name, medIndex, timeIndex);
            alarmIntents.push({
                url: intentUrl,
                name: med.name,
                time: time
            });
        });
    });
    
    // Open first alarm intent
    if (alarmIntents.length > 0) {
        showToast(`üì± Opening Clock app for ${alarmIntents.length} alarm(s)...`);
        
        // Open intents with delay to allow user to set each one
        let currentIndex = 0;
        
        function openNextAlarm() {
            if (currentIndex < alarmIntents.length) {
                const alarm = alarmIntents[currentIndex];
                window.location.href = alarm.url;
                currentIndex++;
                
                // Show progress
                showToast(`‚è∞ Setting alarm ${currentIndex}/${alarmIntents.length}: ${alarm.name} at ${alarm.time}`);
                
                // Wait for user to confirm in Clock app, then open next
                // Note: We can't automatically open all at once, user needs to confirm each
                if (currentIndex < alarmIntents.length) {
                    setTimeout(() => {
                        if (confirm(`Alarm ${currentIndex}/${alarmIntents.length} opened. Ready to set next alarm?\n\n${alarmIntents[currentIndex].name} at ${alarmIntents[currentIndex].time}`)) {
                            openNextAlarm();
                        }
                    }, 2000);
                } else {
                    setTimeout(() => {
                        showToast("‚úì All alarms opened! Please confirm in your Clock app.");
                    }, 2000);
                }
            }
        }
        
        openNextAlarm();
    }
}

function setAllNativeAlarms() {
    const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
    const medications = JSON.parse(localStorage.getItem("medications_" + patientCode) || "[]");
    
    if (medications.length === 0) {
        showToast("‚ö†Ô∏è No medications found. Add medications first.");
        return;
    }
    
    if (!isAndroid) {
        showToast("‚ö†Ô∏è Native alarms only available on Android");
        return;
    }
    
    // Use existing medications as suggestedMedications
    suggestedMedications = medications;
    
    // Show info modal before opening Clock app
    if (confirm("üì± Native Android Alarms\n\nYou'll be redirected to the Clock app to confirm each alarm. Native alarms can bypass Do Not Disturb mode.\n\nThe web app will continue to provide backup reminders.\n\nReady to proceed?")) {
        setNativeAndroidAlarms();
    }
}

async function confirmMedicationSchedule() {
    if (!currentUser || !currentUser.codeHash) {
        showToast("‚ùå User not logged in");
        return;
    }
    
    showToast("üîÑ Saving medications...");
    
    const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
    const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0].codeHash;
    
    // ==================== EDITING EXISTING MEDICATION ====================
    if (window.editingMedicationIndex !== undefined) {
        try {
            // Update in database (both tables)
            await apiCall('/api/medications/update', 'POST', {
                codeHash: codeHash,
                medication: suggestedMedications[0]
            });
            
            // ‚úÖ CLEAR ALL CACHES
            localStorage.removeItem("medications_" + patientCode);
            medicationsCache = [];
            
            // ‚úÖ RELOAD FROM DATABASE
            await fetchMedicationsFromDatabase();
            
            showToast("‚úì Medication updated!");
            
        } catch (error) {
            console.error('Failed to update medication:', error);
            showToast("‚ùå Update failed: " + error.message);
        }
        
        delete window.editingMedicationIndex;
        closeModal("medScheduleModal");
        closeCameraBack();
        
        // ‚úÖ RELOAD REMINDERS IF OPEN
        if (document.getElementById('remindersScreen').classList.contains('active')) {
            await loadReminders();
        }
        
        return;
    }
    
    // ==================== ADDING NEW MEDICATIONS ====================
    try {
        const result = await apiCall('/api/medications/schedule', 'POST', {
            codeHash: codeHash,
            medications: suggestedMedications,
            confirmed: true
        });
        
        if (result.success) {
            // ‚úÖ CLEAR CACHE AND RELOAD
            localStorage.removeItem("medications_" + patientCode);
            medicationsCache = [];
            await fetchMedicationsFromDatabase();
            
            showToast("‚úì Medications saved!");
        } else {
            showToast("‚ùå Failed to save medications");
            return;
        }
    } catch (error) {
        console.error('Save error:', error);
        showToast("‚ö†Ô∏è Saved locally, sync later");
        
        const existingMeds = JSON.parse(localStorage.getItem("medications_" + patientCode) || "[]");
        const updatedMeds = [...existingMeds, ...suggestedMedications];
        localStorage.setItem("medications_" + patientCode, JSON.stringify(updatedMeds));
    }
    
    // Check if user wants to set native Android alarms
    const useNativeAlarms = document.getElementById('useNativeAlarms');
    if (isAndroid && useNativeAlarms && useNativeAlarms.checked) {
        closeModal("medScheduleModal");
        closeCameraBack();
        
        if (confirm("üì± Native Android Alarms\n\nYou'll be redirected to the Clock app to confirm each alarm. Native alarms can bypass Do Not Disturb mode.\n\nThe web app will continue to provide backup reminders.\n\nReady to proceed?")) {
            setNativeAndroidAlarms();
        }
    } else {
        closeModal("medScheduleModal");
        closeCameraBack();
        startAlarmChecker();
    }
}


// Corrected and simplified function to fix both the filtering and the dash insertion
function formatPatientCode(input) {
    // 1. Get the clean alphanumeric data. Allow a-z and A-Z.
    const cleanValue = input.value.replace(/[^0-9a-zA-Z]/g, '').toUpperCase();
    
    // Limit the clean data to the max length of 17 characters (4+4+4+4+1)
    const data = cleanValue.substring(0, 17);

    let formattedValue = '';
    const dataLength = data.length;

    // --- Format as XXXX-XXXX-XXXX-XXXX-X (4-4-4-4-1) ---

    if (dataLength > 0) formattedValue += data.substring(0, 4);
    
    if (dataLength > 4) formattedValue += '-' + data.substring(4, 8);
    
    if (dataLength > 8) formattedValue += '-' + data.substring(8, 12);
    
    if (dataLength > 12) formattedValue += '-' + data.substring(12, 16);
    
    if (dataLength > 16) formattedValue += '-' + data.substring(16, 17);
    
    // 2. Set the input value
    input.value = formattedValue;
}
// ==================== MEDICATIONS ====================
function viewMedications() {
    document.getElementById("dashboardScreen").classList.remove("active");
    document.getElementById("medicationsScreen").classList.add("active");
    pushNavigation('medications');
    loadMedications();
}

function closeMedicationsScreen() {
    document.getElementById("medicationsScreen").classList.remove("active");
    document.getElementById("dashboardScreen").classList.add("active");
    popNavigation();
}

async function loadMedications() {
    const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0].codeHash;
    const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
    const content = document.getElementById("medicationsContent");
    
    console.log('loadMedications called - Role:', currentUser.role, 'CodeHash:', codeHash, 'PatientCode:', patientCode);
    
    // ‚úÖ STEP 1: Fetch medications from database
    content.innerHTML = '<div style="text-align: center; padding: 48px;"><div class="loading-spinner"></div><div style="margin-top: 16px; font-weight: 700; color: var(--text-secondary);">Loading medications...</div></div>';
    
    await fetchMedicationsFromDatabase();
    
    console.log('Medications fetched from DB:', medicationsCache.length);
    
    // ‚úÖ STEP 2: Check for AI insights
    let hasAIInsights = false;
    if (userTier === 'premium') {
        try {
            const result = await apiCall(`/api/health/records/${codeHash}`);
            if (result.success && result.records && result.records.length > 0) {
                const aiRecords = result.records.filter(r => r.recordType === 'ai_analysis');
                if (aiRecords.length > 0) {
                    hasAIInsights = true;
                    const latestInsights = aiRecords[0].metadata.aiInsights;
                    if (latestInsights) {
                        localStorage.setItem('lastAIInsights_' + patientCode, JSON.stringify(latestInsights));
                    }
                }
            }
        } catch (error) {
            console.error('Failed to check AI insights from database:', error);
            hasAIInsights = localStorage.getItem('lastAIInsights_' + patientCode) !== null;
        }
    }
    
    // ‚úÖ STEP 3: Display medications from cache
    if (medicationsCache && medicationsCache.length > 0) {
        let html = "";
        
        //if (hasAIInsights && userTier === 'premium') {
        if (false) {
 html += `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px; border-radius: 20px; margin-bottom: 24px; cursor: pointer; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);" onclick="showAIInsights()">
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="font-size: 48px;">ü§ñ</div>
            <div>
                <div style="color: white; font-size: 20px; font-weight: 900; margin-bottom: 4px;">AI Insights Available</div>
                <div style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600;">Click to view personalized health analysis</div>
            </div>
        </div>
        <div style="color: white; font-size: 24px;">‚Üí</div>
    </div>
</div>`;
        }
        
        medicationsCache.forEach((med, index) => {
            html += `<div class="med-list-item">
                <div class="med-title">${med.name}</div>
                <div class="med-info">üíä ${med.dosage}</div>
                <div class="med-info">üìÖ ${med.frequency}x daily</div>
                <div class="med-schedule">${med.times.map(t => `<div class="time-badge">${t}</div>`).join("")}</div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="editMedication(${index})" style="flex: 1; padding: 14px; margin: 0;">‚úèÔ∏è Edit</button>
                    <button class="btn btn-secondary" onclick="deleteMedication(${index})" style="flex: 1; padding: 14px; margin: 0; background: var(--danger-gradient); color: white;">üóëÔ∏è Delete</button>
                </div>
            </div>`;
        });
        content.innerHTML = html;
    } else {
        // No medications found
        if (userTier === 'premium') {
            content.innerHTML = '<div class="empty-state"><div class="empty-icon">üíä</div><div class="empty-title">No Medications</div><p class="empty-text">Scan a prescription to get started</p><button class="btn btn-primary" onclick="closeMedicationsScreen(); openCamera();">Scan Prescription</button></div>';
        } else {
            content.innerHTML = '<div class="empty-state"><div class="empty-icon">üíä</div><div class="empty-title">No Medications</div><p class="empty-text">Add medications to get started</p><button class="btn btn-primary" onclick="addManualMedication()">+ Add Medication</button></div>';
        }
    }
}

function addManualMedication() {
    const medName = prompt("Medication Name:");
    if (!medName) return;
    
    const dosage = prompt("Dosage (e.g., 500mg, 1 tablet):");
    if (!dosage) return;
    
    const frequency = parseInt(prompt("How many times per day? (1-4):"));
    if (!frequency || frequency < 1 || frequency > 4) {
        showToast("Invalid frequency");
        return;
    }
    
    const times = [];
    for (let i = 0; i < frequency; i++) {
        const time = prompt(`Time ${i + 1} (HH:MM format, e.g., 09:00):`);
        if (!time || !time.match(/^\d{2}:\d{2}$/)) {
            showToast("Invalid time format");
            return;
        }
        times.push(time);
    }
    
    const medication = {
        name: medName,
        dosage: dosage,
        frequency: frequency,
        times: times,
        instructions: 'Manually added',
        active: true
    };
    
    suggestedMedications = [medication];
    showMedicationSchedule([medication]);
}

function editMedication(index) {
    const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
    const medications = JSON.parse(localStorage.getItem("medications_" + patientCode) || "[]");
    const med = medications[index];
    
    suggestedMedications = [med];
    showMedicationSchedule([med]);
    
    window.editingMedicationIndex = index;
}

async function deleteMedication(index) {
    if (!confirm("Are you sure you want to delete this medication?")) return;
    
    const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0].codeHash;
    
    showToast("üîÑ Deleting...");
    
    try {
        // Get medication list from database
        const medications = await apiCall(`/api/medications/${codeHash}`);
        if (!medications.success || !medications.medications[index]) {
            showToast("‚ùå Medication not found");
            return;
        }
        
        const medName = medications.medications[index].name;
        
        // Delete from database
        await apiCall('/api/medications/delete', 'POST', {
            codeHash: codeHash,
            medicationName: medName
        });
        
        showToast("‚úì Medication deleted");
        loadMedications(); // Reload from database
    } catch (error) {
        console.error('Delete failed:', error);
        showToast("‚ùå Delete failed");
    }
}


        async function editMedication(index) {
    const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0].codeHash;
    
    try {
        const medications = await apiCall(`/api/medications/${codeHash}`);
        if (!medications.success || !medications.medications[index]) {
            showToast("‚ùå Medication not found");
            return;
        }
        
        const med = medications.medications[index];
        
        suggestedMedications = [med];
        showMedicationSchedule([med]);
        
        window.editingMedicationIndex = index;
    } catch (error) {
        console.error('Failed to load medication:', error);
        showToast("‚ùå Failed to load medication");
    }
}

// ==================== REMINDERS ====================
function viewReminders() {
    document.getElementById("dashboardScreen").classList.remove("active");
    document.getElementById("remindersScreen").classList.add("active");
    pushNavigation('reminders');
    loadReminders();
}

function closeRemindersScreen() {
    document.getElementById("remindersScreen").classList.remove("active");
    document.getElementById("dashboardScreen").classList.add("active");
    popNavigation();
}

// FIND loadReminders function (around line 2940) and REPLACE with:

function loadReminders() {
    const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0].codeHash;
    const content = document.getElementById("remindersContent");
    
    content.innerHTML = '<div style="text-align: center; padding: 48px;"><div class="loading-spinner"></div><div style="margin-top: 16px; font-weight: 700; color: var(--text-secondary);">Loading reminders...</div></div>';
    
    // Load medications, appointments, AND alarms (removed non-existent status endpoint)
    Promise.all([
        apiCall('/api/medications/' + codeHash, 'GET'),
        apiCall('/api/health/appointments/' + codeHash, 'GET'),
        apiCall('/api/alarms?code_hash=' + codeHash, 'GET')
    ]).then(([medResult, apptResult, alarmResult]) => {
        const medications = medResult.success ? medResult.medications : [];
        const appointments = apptResult.success ? apptResult.appointments : [];
        const alarms = Array.isArray(alarmResult) ? alarmResult : (alarmResult || []);
        
        console.log('Medications fetched from DB:', medications.length);
        console.log('Alarms fetched:', alarms.length);
        
        renderReminders(medications, appointments, alarms, {}, content);
    }).catch(error => {
        console.error('Failed to load reminders:', error);
        content.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Error Loading</div><p class="empty-text">Could not load reminders</p></div>';
    });
}

        // Add this utility function once in your script
function isIPadOS() {
    // Check for "iPad" or check for "Macintosh" AND touch support (for modern iPadOS)
    return /iPad/i.test(navigator.userAgent) || 
           (/Macintosh/i.test(navigator.userAgent) && navigator.maxTouchPoints > 1);
}
function renderReminders(medications, appointments, alarms, alarmStatuses, content) {
    const now = new Date();
    const today = now.toDateString();
    const todayDate = now.toISOString().split('T')[0]; // YYYY-MM-DD
    
    // Ensure alarmStatuses is an object
    if (!alarmStatuses) alarmStatuses = {};
    
    let html = "";
    
    // Show upcoming appointments first
    if (appointments && appointments.length > 0) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const upcomingAppointments = appointments.filter(appt => {
            const apptDate = new Date(appt.date);
            apptDate.setHours(0, 0, 0, 0);
            return apptDate >= today;
        }).sort((a, b) => new Date(a.date) - new Date(b.date));
        
        if (upcomingAppointments.length > 0) {
            html += '<div style="margin-bottom: 32px;">';
            html += '<h3 style="color: var(--accent-primary); font-size: 22px; font-weight: 900; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;"><span>üìÖ</span> Upcoming Appointments</h3>';
            
            upcomingAppointments.forEach(appt => {
                const apptDate = new Date(appt.date);
                const formattedDate = apptDate.toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long',
                    year: 'numeric'
                });
                
                const daysUntil = Math.ceil((apptDate - today) / (1000 * 60 * 60 * 24));
                let urgencyBadge = '';
                if (daysUntil === 0) {
                    urgencyBadge = '<span style="background: #ef4444; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 700; margin-left: 12px;">TODAY</span>';
                } else if (daysUntil <= 3) {
                    urgencyBadge = `<span style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 700; margin-left: 12px;">IN ${daysUntil} DAYS</span>`;
                }
                
                html += `<div style="background: var(--bg-card); padding: 24px; border-radius: 20px; margin-bottom: 16px; border-left: 6px solid #9333ea; box-shadow: var(--shadow-sm);">
                    <div style="font-weight: 900; font-size: 20px; margin-bottom: 8px; color: var(--text-primary);">${escapeHtml(appt.title)}${urgencyBadge}</div>
                    <div style="color: var(--text-secondary); font-size: 16px; font-weight: 600; margin-bottom: 4px;">üìÖ ${formattedDate}</div>
                    ${appt.time ? `<div style="color: var(--text-secondary); font-size: 16px; font-weight: 600;">‚è∞ ${escapeHtml(appt.time)}</div>` : ''}
                    ${appt.notes ? `<div style="color: var(--text-secondary); font-size: 14px; margin-top: 8px; font-style: italic;">${escapeHtml(appt.notes)}</div>` : ''}
                </div>`;
            });
            
            html += '</div>';
        }
    }
    
    // Show active alarms
    if (alarms && alarms.length > 0) {
        html += '<h3 style="color: var(--accent-primary); font-size: 22px; font-weight: 900; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;"><span>‚è∞</span> Active Alarms</h3>';
        
        alarms.forEach(alarm => {
            const status = alarm.daily_status || 'PENDING';
            let statusBadge = '';
            let statusColor = '#6b7280';
            
            if (status === 'TAKEN') {
                statusBadge = '‚úÖ TAKEN';
                statusColor = '#10b981';
            } else if (status === 'REMINDED') {
                statusBadge = 'üîî REMINDED';
                statusColor = '#f59e0b';
            } else if (status === 'FOLLOWUP') {
                statusBadge = 'üìû FOLLOWUP';
                statusColor = '#ef4444';
            } else {
                statusBadge = '‚è≥ PENDING';
                statusColor = '#6b7280';
            }
            
            html += `<div class="med-list-item" style="border-left: 4px solid ${statusColor};">
                <div class="med-title">${escapeHtml(alarm.medication_name)}</div>
                <div class="med-info">‚è∞ ${escapeHtml(alarm.time)}</div>
                <div style="margin-top: 8px;">
                    <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 700;">${statusBadge}</span>
                </div>
                <div style="margin-top: 16px;">
                    <button class="btn btn-secondary" onclick="deleteAlarmFromScreen(${alarm.id}, '${alarm.medication_name.replace(/'/g, "\\'")}', '${escapeHtml(alarm.time)}')" style="padding: 12px 20px; margin: 0; background: var(--danger-gradient); color: white; font-size: 14px;">üóëÔ∏è Delete</button>
                </div>
            </div>`;
        });
    }
    
    // Show medications
    // Show medications
if (medications && medications.length > 0) {
    html += '<h3 style="color: var(--accent-primary); font-size: 22px; font-weight: 900; margin-top: 32px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;"><span>üíä</span> Today\'s Medications</h3>';
    
    medications.forEach(med => {
        const times = med.times || [];
        const takenStatus = med.takenStatus || {};
        
        html += `<div class="med-list-item">
            <div class="med-title">${escapeHtml(med.name)}</div>
            <div class="med-info">${escapeHtml(med.dosage || '')}</div>
            <div class="med-info">${escapeHtml(med.instructions || '')}</div>
            
            ${times.length > 0 ? `
            <div style="margin-top: 16px;">
                <div style="font-weight: 700; color: var(--text-secondary); margin-bottom: 12px; font-size: 14px;">Scheduled Times:</div>
                ${times.map(time => {
                    const isTaken = takenStatus[time] === true;
                    
                    return `<div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: var(--text-primary);">‚è∞ ${escapeHtml(time)}</span>
                        ${isTaken 
                            ? '<span style="color: #10b981; font-weight: 700; font-size: 14px;">‚úÖ Taken</span>'
                            : `<button class="btn btn-primary" onclick="markAsTaken('${med.name.replace(/'/g, "\\'")}', '${time}')" style="padding: 8px 16px; margin: 0; font-size: 13px;">Mark Taken</button>`
                        }
                    </div>`;
                }).join('')}
            </div>
            ` : '<div style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">No scheduled times</div>'}
            
            <div style="margin-top: 16px; display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="editMedicationSchedule('${med.name.replace(/'/g, "\\'")}')" style="flex: 1; padding: 12px; margin: 0;">‚úèÔ∏è Edit</button>
                <button class="btn btn-secondary" onclick="deleteMedicationCompletely('${med.name.replace(/'/g, "\\'")}')" style="flex: 1; padding: 12px; margin: 0; background: var(--danger-gradient); color: white;">üóëÔ∏è Delete</button>
            </div>
        </div>`;
    });
}
    
    if (!html) {
        html = '<div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);"><div style="font-size: 64px; margin-bottom: 20px;">üíä</div><div style="font-size: 18px; font-weight: 600;">No medications or appointments scheduled yet</div><div style="font-size: 14px; margin-top: 8px;">Add your first medication to get started</div></div>';
    }
    
    if (content) {
        content.innerHTML = html;
    }
    
    return html;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

    
// ==================== AI CHAT ====================

        
// ==================== AI CHAT ====================
function viewAIChat() {
    if (userTier !== 'premium') {
        showUpgradeModal();
        return;
    }
    
    document.getElementById("dashboardScreen").classList.remove("active");
    document.getElementById("aiChatScreen").classList.add("active");
    pushNavigation('aiChat');
    loadChatHistory();
}

function closeAIChatScreen() {
    document.getElementById("aiChatScreen").classList.remove("active");
    document.getElementById("dashboardScreen").classList.add("active");
    popNavigation();
}

async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const query = input.value.trim();
    
    if (!query) return;
    
    // Stop any ongoing speech when user sends a message
    if (synthesis) synthesis.cancel();
    
    // FIXED: Better user verification
    if (!currentUser) {
        showToast("‚ùå Please login first");
        return;
    }
    
    let codeHash;
    if (currentUser.role === "patient") {
        codeHash = currentUser.codeHash;
    } else if (currentUser.patients && currentUser.patients.length > 0) {
        codeHash = currentUser.patients[0].codeHash;
    } else {
        showToast("‚ùå User data not found");
        return;
    }
    
    // Add user message to chat
    addChatMessage(query, 'user');
    input.value = '';
    
    // Show loading
    const loadingId = 'loading-' + Date.now();
    const loadingMsg = document.createElement('div');
    loadingMsg.id = loadingId;
    loadingMsg.style.cssText = `
        padding: 16px 20px;
        margin-bottom: 12px;
        border-radius: 16px;
        background: var(--bg-secondary);
        margin-right: 40px;
        font-weight: 600;
        line-height: 1.7;
        box-shadow: var(--shadow-sm);
    `;
    loadingMsg.innerHTML = '<div class="loading-spinner"></div> Thinking...';
    document.getElementById('chatHistory').appendChild(loadingMsg);
    document.getElementById('chatHistory').scrollTop = document.getElementById('chatHistory').scrollHeight;
    
    try {
        const result = await apiCall('/api/dementia/query', 'POST', {
            codeHash: codeHash,
            query: query
        });
        
        // Remove loading message
        document.getElementById(loadingId)?.remove();
        
        if (result.success) {
            // Use original function to avoid double-speaking
            originalAddChatMessage(result.answer, 'assistant');
            
            // Manually trigger speech if auto-speak is enabled
            if (document.getElementById('autoSpeak')?.checked) {
                setTimeout(() => speakText(result.answer), 500);
            }
            
            // Show sources if available
            if (result.sources && result.sources.length > 0) {
                let sourcesHTML = '<div style="margin-top: 12px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 12px; font-size: 13px;"><strong>üìö Sources:</strong><br>';
                result.sources.slice(0, 3).forEach(source => {
                    sourcesHTML += `<div style="margin-top: 6px;">‚Ä¢ ${source.title || 'Research paper'}</div>`;
                });
                sourcesHTML += '</div>';
                originalAddChatMessage(sourcesHTML, 'assistant');
            }
        } else {
            originalAddChatMessage('‚ùå Failed to get response. Please try again.', 'assistant');
        }
    } catch (error) {
        document.getElementById(loadingId)?.remove();
        originalAddChatMessage('‚ùå Error: ' + error.message, 'assistant');
    }
}

function addChatMessage(content, sender, id = null) {
    const chatHistory = document.getElementById('chatHistory');
    const messageDiv = document.createElement('div');
    if (id) messageDiv.id = id;
    
    const isUser = sender === 'user';
    messageDiv.style.cssText = `
        padding: 16px 20px;
        margin-bottom: 12px;
        border-radius: 16px;
        ${isUser ? 'background: var(--accent-gradient); color: white; margin-left: 40px;' : 'background: var(--bg-secondary); margin-right: 40px;'}
        font-weight: 600;
        line-height: 1.7;
        box-shadow: var(--shadow-sm);
    `;
    
    messageDiv.innerHTML = content;
    chatHistory.appendChild(messageDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

async function loadChatHistory() {
    const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0].codeHash;
    
    try {
    const result = await apiCall(`/api/dementia/history/${codeHash}`);
        
        if (result.success && result.conversations && result.conversations.length > 0) {
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.innerHTML = '';
            
            result.conversations.slice(-10).forEach(conv => {
                addChatMessage(conv.query, 'user');
                addChatMessage(conv.response, 'assistant');
            });
        }
    } catch (error) {
        console.error('Failed to load chat history:', error);
    }
}


async function deleteReminderFromScreen(medIndex, medName) {
    if (!confirm(`Delete ${medName} and all its reminders?`)) return;
    
    showToast("üîÑ Deleting medication...");
    
    const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0].codeHash;
    const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
    
    try {
        // Delete from backend database
        const result = await apiCall('/api/medications/delete', 'POST', {
            codeHash: codeHash,
            medicationName: medName
        });
        
        if (result.success) {
            // Delete from localStorage
            const medications = JSON.parse(localStorage.getItem("medications_" + patientCode) || "[]");
            medications.splice(medIndex, 1);
            localStorage.setItem("medications_" + patientCode, JSON.stringify(medications));
            
            showToast("‚úì Medication deleted!");
            
            // Reload reminders screen
            loadReminders();
        } else {
            showToast("‚ùå Failed to delete");
        }
    } catch (error) {
        console.error('Delete error:', error);
        
        // Still delete from localStorage if backend fails
        const medications = JSON.parse(localStorage.getItem("medications_" + patientCode) || "[]");
        medications.splice(medIndex, 1);
        localStorage.setItem("medications_" + patientCode, JSON.stringify(medications));
        
        showToast("‚ö†Ô∏è Deleted locally, sync later");
        loadReminders();
    }
}
// Same HTML file - Add in <script> section around line 2900

let isVoiceChatActive = false;
let voiceChatRecognition = null;
let voiceChatSynthesis = window.speechSynthesis;

function toggleVoiceChat() {
    if (isVoiceChatActive) {
        stopVoiceChat();
    } else {
        startVoiceChat();
    }
}

function startVoiceChat() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showToast('‚ùå Voice chat not supported in this browser');
        return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    voiceChatRecognition = new SpeechRecognition();
    voiceChatRecognition.continuous = false;
    voiceChatRecognition.interimResults = false;
    voiceChatRecognition.lang = 'en-US';
    
    voiceChatRecognition.onstart = function() {
        isVoiceChatActive = true;
        document.getElementById('voiceChatStatus').textContent = 'üé§ Listening...';
        document.getElementById('voiceChatBtn').textContent = '‚èπÔ∏è';
        document.getElementById('voiceChatBtn').style.background = 'var(--danger-gradient)';
        document.getElementById('listeningRing').classList.add('active');
        document.getElementById('aiAvatar').classList.add('listening');
    };
    
    voiceChatRecognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('voiceChatStatus').textContent = `You said: "${transcript}"`;
        
        // Stop listening animation
        document.getElementById('listeningRing').classList.remove('active');
        
        // Get AI response
        getVoiceChatResponse(transcript);
    };
    
    voiceChatRecognition.onerror = function(event) {
        console.error('Voice chat error:', event.error);
        if (event.error === 'no-speech') {
            showToast('‚ö†Ô∏è No speech detected. Try again.');
        } else if (event.error === 'not-allowed') {
            showToast('‚ùå Microphone access denied');
        } else {
            showToast('‚ùå Voice error: ' + event.error);
        }
        stopVoiceChat();
    };
    
    voiceChatRecognition.onend = function() {
        if (isVoiceChatActive && !document.getElementById('voiceChatStatus').textContent.includes('You said:')) {
            stopVoiceChat();
        }
    };
    
    try {
        voiceChatRecognition.start();
        showToast('üé§ Speak now...');
    } catch (error) {
        console.error('Start voice error:', error);
        showToast('‚ùå Could not start voice input');
        stopVoiceChat();
    }
}

function stopVoiceChat() {
    if (voiceChatRecognition) {
        voiceChatRecognition.stop();
    }
    isVoiceChatActive = false;
    
    document.getElementById('voiceChatStatus').textContent = 'Tap to talk with your AI coach';
    document.getElementById('voiceChatBtn').textContent = 'üé§';
    document.getElementById('voiceChatBtn').style.background = 'var(--accent-gradient)';
    document.getElementById('listeningRing').classList.remove('active');
    document.getElementById('aiAvatar').classList.remove('listening');
}

async function getVoiceChatResponse(userMessage) {
    document.getElementById('voiceChatStatus').textContent = 'ü§î Thinking...';
    
    const codeHash = currentUser?.codeHash || currentUser?.patients?.[0]?.codeHash;
    
    if (!codeHash) {
        speakVoiceResponse("I'm sorry, I couldn't verify your account. Please try logging in again.");
        setTimeout(() => stopVoiceChat(), 3000);
        return;
    }
    
    try {
        const result = await apiCall('/api/dementia/query', 'POST', {
            codeHash: codeHash,
            query: userMessage
        });
        
        if (result.success && result.answer) {
            speakVoiceResponse(result.answer);
        } else {
            speakVoiceResponse("I'm sorry, I couldn't generate a response. Please try again.");
        }
    } catch (error) {
        console.error('Voice chat API error:', error);
        speakVoiceResponse("I'm having trouble connecting. Please check your internet connection and try again.");
    }
    
    setTimeout(() => stopVoiceChat(), 1000);
}

function speakVoiceResponse(text) {
    // Stop any ongoing speech
    voiceChatSynthesis.cancel();
    
    document.getElementById('voiceChatStatus').textContent = 'üó£Ô∏è Speaking...';
    document.getElementById('aiAvatar').classList.add('listening');
    
    // Clean text for speech
    let cleanText = text
        .replace(/\*\*([^*]+)\*\*/g, '$1')
        .replace(/\*([^*]+)\*/g, '$1')
        .replace(/#{1,6}\s/g, '')
        .replace(/\[Source \d+\]/g, '')
        .replace(/‚ö†Ô∏è|üíä|üìö|‚Ä¢/g, '')
        .replace(/\n+/g, '. ');
    
    // Split into chunks if too long
    const chunks = splitIntoChunks(cleanText, 200);
    
    chunks.forEach((chunk, index) => {
        const utterance = new SpeechSynthesisUtterance(chunk);
        utterance.lang = 'en-GB';  // British English for European feel
        utterance.rate = 0.85;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        
        if (index === chunks.length - 1) {
            utterance.onend = () => {
                document.getElementById('aiAvatar').classList.remove('listening');
                setTimeout(() => stopVoiceChat(), 1000);
            };
        }
        
        voiceChatSynthesis.speak(utterance);
    });
}

async function deleteAlarmFromScreen(alarmId, medicationName) {
    if (!confirm(`Delete alarm for ${medicationName}?`)) return;
    
    showToast("üîÑ Deleting alarm...");
    
    try {
        const result = await apiCall('/api/alarms/' + alarmId, 'DELETE');
        
        if (result.success) {
            showToast("‚úì Alarm deleted!");
            loadReminders();
        } else {
            showToast("‚ùå Failed to delete");
        }
    } catch (error) {
        console.error('Delete alarm error:', error);
        showToast("‚ùå Error deleting alarm");
    }
}        
// ==================== VOICE CHAT (TTS & STT) ====================
let recognition = null;
let synthesis = window.speechSynthesis;
let isListening = false;

function initializeSpeechRecognition() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.log('Speech recognition not supported');
        return null;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognizer = new SpeechRecognition();
    
    recognizer.continuous = false;
    recognizer.interimResults = false;
    recognizer.lang = 'en-US';
    
    recognizer.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('chatInput').value = transcript;
        stopVoiceInput();
        showToast('‚úì Voice input received');
    };
    
    recognizer.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        stopVoiceInput();
        if (event.error === 'no-speech') {
            showToast('‚ö†Ô∏è No speech detected. Try again.');
        } else if (event.error === 'not-allowed') {
            showToast('‚ùå Microphone access denied');
        } else {
            showToast('‚ùå Voice input error: ' + event.error);
        }
    };
    
    recognizer.onend = function() {
        if (isListening) {
            stopVoiceInput();
        }
    };
    
    return recognizer;
}

function toggleVoiceInput() {
    if (!recognition) {
        recognition = initializeSpeechRecognition();
        if (!recognition) {
            showToast('‚ùå Voice input not supported in this browser');
            return;
        }
    }
    
    if (isListening) {
        stopVoiceInput();
    } else {
        startVoiceInput();
    }
}

function startVoiceInput() {
    try {
        recognition.start();
        isListening = true;
        
        document.getElementById('voiceBtnIcon').textContent = '‚èπÔ∏è';
        document.getElementById('voiceBtn').style.background = 'var(--danger-gradient)';
        document.getElementById('voiceStatus').style.display = 'block';
        
        showToast('üé§ Listening... Speak now!');
    } catch (error) {
        console.error('Start voice error:', error);
        showToast('‚ùå Could not start voice input');
        isListening = false;
    }
}

function stopVoiceInput() {
    if (recognition && isListening) {
        recognition.stop();
    }
    isListening = false;
    
    document.getElementById('voiceBtnIcon').textContent = 'üé§';
    document.getElementById('voiceBtn').style.background = 'var(--accent-gradient)';
    document.getElementById('voiceStatus').style.display = 'none';
}

function speakText(text) {
    // Stop any ongoing speech
    synthesis.cancel();
    
    // Remove markdown formatting for cleaner speech
    let cleanText = text
        .replace(/\*\*([^*]+)\*\*/g, '$1')  // Remove bold
        .replace(/\*([^*]+)\*/g, '$1')       // Remove italic
        .replace(/#{1,6}\s/g, '')            // Remove headers
        .replace(/\[Source \d+\]/g, '')      // Remove source citations
        .replace(/‚ö†Ô∏è|üíä|üìö|‚Ä¢/g, '')          // Remove emojis
        .replace(/\n+/g, '. ');               // Replace newlines with pauses
    
    // Split into chunks if too long (browser limit ~200 chars)
    const chunks = splitIntoChunks(cleanText, 200);
    
    chunks.forEach((chunk, index) => {
        const utterance = new SpeechSynthesisUtterance(chunk);
        utterance.lang = 'en-US';
        utterance.rate = 0.9;  // Slightly slower for clarity
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        
        // Add pauses between chunks
        if (index < chunks.length - 1) {
            utterance.onend = () => setTimeout(() => {}, 500);
        }
        
        synthesis.speak(utterance);
    });
}

function splitIntoChunks(text, maxLength) {
    const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
    const chunks = [];
    let currentChunk = '';
    
    sentences.forEach(sentence => {
        if ((currentChunk + sentence).length <= maxLength) {
            currentChunk += sentence;
        } else {
            if (currentChunk) chunks.push(currentChunk.trim());
            currentChunk = sentence;
        }
    });
    
    if (currentChunk) chunks.push(currentChunk.trim());
    return chunks;
}

function testVoice() {
    const testMessage = "Hello! This is a test of the voice assistant. I can help you with dementia caregiving questions.";
    speakText(testMessage);
    showToast('üîä Playing test voice...');
}

// Auto-speak responses when enabled
const originalAddChatMessage = addChatMessage;
addChatMessage = function(content, sender, id = null) {
    originalAddChatMessage(content, sender, id);
    
    // Auto-speak assistant responses if enabled
    if (sender === 'assistant' && document.getElementById('autoSpeak')?.checked) {
        // Wait a moment for message to render
        setTimeout(() => {
            speakText(content);
        }, 500);
    }
};

        
// ==================== AI ANALYSIS ====================
async function viewAIAnalysis() {
    if (userTier !== 'premium') {
        showUpgradeModal();
        return;
    }
    
    document.getElementById("dashboardScreen").classList.remove("active");
    document.getElementById("aiAnalysisScreen").classList.add("active");
    pushNavigation('aiAnalysis');
    
    const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
    const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0].codeHash;
    const content = document.getElementById("aiAnalysisContent");
    
    let insights = null;
    try {
        const result = await apiCall(`/api/health/records/${codeHash}`);
        if (result.success && result.records && result.records.length > 0) {
            const aiRecords = result.records.filter(r => r.recordType === 'ai_analysis');
            if (aiRecords.length > 0) {
                const latestRecord = aiRecords[0];
                insights = latestRecord.metadata.aiInsights;
                if (insights) {
                    localStorage.setItem('lastAIInsights_' + patientCode, JSON.stringify(insights));
                }
            }
        }
    } catch (error) {
        console.error('Failed to load AI insights from database:', error);
    }
    
    if (!insights) {
        const lastInsights = localStorage.getItem('lastAIInsights_' + patientCode);
        if (lastInsights) {
            insights = JSON.parse(lastInsights);
        }
    }
    
    if (insights) {
        const analysis = insights.analysis || "No analysis available";
        const formattedHTML = formatAIAnalysisToHTML(analysis);
        
        const patientInfo = currentUser.role === "patient" 
            ? currentUser.displayName
            : currentUser.patients[0].displayName;
        
        content.innerHTML = `<div style="background: var(--bg-glass); backdrop-filter: blur(24px); padding: 36px; border-radius: 28px; box-shadow: var(--shadow-md); border: 2px solid rgba(102, 126, 234, 0.15);">
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 28px; padding-bottom: 24px; border-bottom: 2px solid rgba(102, 126, 234, 0.2);">
                <div style="font-size: 48px;">ü§ñ</div>
                <div style="flex: 1;">
                    <h3 style="font-size: 28px; font-weight: 900; color: var(--text-primary); margin-bottom: 8px;">AI Health Insights</h3>
                    <p style="font-size: 14px; color: var(--text-secondary); font-weight: 600;">
                        For ${patientInfo}
                        ${insights.personalized ? ' ‚Ä¢ Age-specific analysis (' + (insights.age_group || 'N/A') + ')' : ''}
                        ${insights.model ? ' ‚Ä¢ Powered by ' + insights.model : ''}
                    </p>
                </div>
            </div>
            <div style="color: var(--text-primary); font-size: 15px; line-height: 1.8;">
                ${formattedHTML}
            </div>
            <div style="margin-top: 32px; padding: 20px; background: rgba(252, 129, 129, 0.1); border-left: 4px solid #fc8181; border-radius: 16px;">
                <div style="font-weight: 800; color: #c53030; margin-bottom: 8px; font-size: 15px;">‚ö†Ô∏è Important Disclaimer</div>
                <p style="color: #742a2a; font-size: 14px; font-weight: 600; line-height: 1.6;">This is AI-generated information for educational purposes only. Always consult your healthcare provider for medical decisions.</p>
            </div>
        </div>`;
    } else {
        content.innerHTML = '<div class="empty-state"><div class="empty-icon">ü§ñ</div><div class="empty-title">AI Insights</div><p class="empty-text">Scan a prescription to get AI insights</p><button class="btn btn-primary" onclick="closeAIAnalysisScreen(); openCamera();">Scan Prescription</button></div>';
    }
}

function formatAIAnalysisToHTML(text) {
    let html = text;
    
    html = html.replace(/\*\*([^*]+)\*\*/g, '<h4 style="font-size: 18px; font-weight: 800; color: var(--accent-primary); margin: 24px 0 16px 0; letter-spacing: -0.3px;">$1</h4>');
    html = html.replace(/\*([^*]+)\*/g, '<strong style="font-weight: 700; color: var(--text-primary);">$1</strong>');
    html = html.replace(/^- (.+)$/gm, '<li style="margin-left: 20px; margin-bottom: 12px; line-height: 1.7;">$1</li>');
    html = html.replace(/(<li[^>]*>.*<\/li>)/s, '<ul style="margin: 16px 0; padding-left: 20px;">$1</ul>');
    html = html.replace(/^(\d+)\. (.+)$/gm, '<li style="margin-left: 20px; margin-bottom: 12px; line-height: 1.7;">$2</li>');
    
    html = html.split('\n\n').map(para => {
        if (para.trim() && !para.includes('<h4') && !para.includes('<li') && !para.includes('<ul')) {
            return `<p style="margin-bottom: 16px; font-weight: 500; line-height: 1.8;">${para.trim()}</p>`;
        }
        return para;
    }).join('\n');
    
    html = html.replace(/‚ö†Ô∏è/g, '<span style="color: #fc8181; font-size: 18px;">‚ö†Ô∏è</span>');
    html = html.replace(/üíä/g, '<span style="font-size: 18px;">üíä</span>');
    
    return html;
}

function closeAIAnalysisScreen() {
    document.getElementById("aiAnalysisScreen").classList.remove("active");
    document.getElementById("dashboardScreen").classList.add("active");
    popNavigation();
}

// ==================== HEALTH CHARTS ====================
function viewHealth() {
    if (userTier !== 'premium') {
        showUpgradeModal();
        return;
    }
    document.getElementById("dashboardScreen").classList.remove("active");
    document.getElementById("healthScreen").classList.add("active");
    pushNavigation('health');
    loadMedicationAdherence();
    renderBPChart();
    renderSugarChart();
}

function loadMedicationAdherence() {
    const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0].codeHash;
    
    apiCall('/api/health/medication-adherence/' + codeHash, 'GET').then(result => {
        if (result.success && result.adherence) {
            const stats = result.adherence;
            
            document.getElementById('todayCount').textContent = stats.todayRecords;
            document.getElementById('week7Count').textContent = stats.last7Days;
            document.getElementById('totalCount').textContent = stats.totalRecords;
            
            const historyContainer = document.getElementById('adherenceHistory');
            if (stats.history && stats.history.length > 0) {
                let html = '<div style="font-size: 15px; font-weight: 800; color: var(--text-secondary); margin-bottom: 12px;">Recent Activity</div>';
                html += '<div style="display: flex; flex-direction: column; gap: 10px;">';
                
                stats.history.slice().reverse().forEach(record => {
                    const takenDate = new Date(record.takenAt);
                    const timeStr = takenDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    const dateStr = takenDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                    
                    html += `<div style="background: var(--bg-primary); padding: 14px; border-radius: 12px; border-left: 4px solid #48bb78;">
                        <div style="font-weight: 800; font-size: 15px; color: var(--text-primary);">${record.medication}</div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px; font-weight: 600;">
                            ‚úì Taken at ${timeStr} ‚Ä¢ ${dateStr}
                            ${record.scheduledTime ? `<span style="color: var(--text-tertiary);"> (scheduled ${record.scheduledTime})</span>` : ''}
                        </div>
                    </div>`;
                });
                
                html += '</div>';
                historyContainer.innerHTML = html;
            } else {
                historyContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 24px; font-weight: 700;">No medication history yet</div>';
            }
        }
    }).catch(error => {
        console.error('Failed to load adherence data:', error);
        document.getElementById('adherenceHistory').innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 24px; font-weight: 700;">Failed to load adherence data</div>';
    });
}

function closeHealthScreen() {
    document.getElementById("healthScreen").classList.remove("active");
    document.getElementById("dashboardScreen").classList.add("active");
    popNavigation();
}

function addBPReading() {
    const systolic = document.getElementById("bpSystolic").value;
    const diastolic = document.getElementById("bpDiastolic").value;
    
    if (!systolic || !diastolic) return;
    
    const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
    const readings = JSON.parse(localStorage.getItem("bp_" + patientCode) || "[]");
    
    readings.push({systolic: systolic, diastolic: diastolic, date: new Date().toLocaleDateString()});
    
    localStorage.setItem("bp_" + patientCode, JSON.stringify(readings));
    document.getElementById("bpSystolic").value = "";
    document.getElementById("bpDiastolic").value = "";
    showToast("‚úì BP recorded");
    renderBPChart();
}

function addSugarReading() {
    const value = document.getElementById("bloodSugar").value;
    const context = document.getElementById("sugarContext").value;
    
    if (!value) return;
    
    const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
    const readings = JSON.parse(localStorage.getItem("sugar_" + patientCode) || "[]");
    
    readings.push({value: value, context: context, date: new Date().toLocaleDateString()});
    
    localStorage.setItem("sugar_" + patientCode, JSON.stringify(readings));
    document.getElementById("bloodSugar").value = "";
    showToast("‚úì Sugar recorded");
    renderSugarChart();
}

function renderBPChart() {
    const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
    const readings = JSON.parse(localStorage.getItem("bp_" + patientCode) || "[]");
    const container = document.getElementById("bpChart");
    
    if (readings.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 48px; font-weight: 700;">No readings yet</div>';
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 14px;">';
    readings.slice(-10).reverse().forEach(reading => {
        const color = reading.systolic > 140 ? "#fc8181" : reading.systolic > 120 ? "#fbbf24" : "#48bb78";
        html += `<div style="background: var(--bg-glass); backdrop-filter: blur(12px); padding: 20px; border-radius: 16px; border-left: 6px solid ${color}; transition: all 0.2s; box-shadow: var(--shadow-sm);">
            <div style="font-weight: 900; font-size: 22px;">${reading.systolic} / ${reading.diastolic} <span style="font-size: 15px; color: var(--text-secondary);">mmHg</span></div>
            <div style="font-size: 14px; color: var(--text-secondary); margin-top: 6px; font-weight: 700;">${reading.date}</div>
        </div>`;
    });
    html += '</div>';
    container.innerHTML = html;
}

function renderSugarChart() {
    const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
    const readings = JSON.parse(localStorage.getItem("sugar_" + patientCode) || "[]");
    const container = document.getElementById("sugarChart");
    
    if (readings.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 48px; font-weight: 700;">No readings yet</div>';
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 14px;">';
    readings.slice(-10).reverse().forEach(reading => {
        const color = reading.value > 180 ? "#fc8181" : reading.value > 130 ? "#fbbf24" : reading.value < 70 ? "#fc8181" : "#48bb78";
        html += `<div style="background: var(--bg-glass); backdrop-filter: blur(12px); padding: 20px; border-radius: 16px; border-left: 6px solid ${color}; transition: all 0.2s; box-shadow: var(--shadow-sm);">
            <div style="font-weight: 900; font-size: 22px;">${reading.value} <span style="font-size: 15px; color: var(--text-secondary);">mg/dL</span></div>
            <div style="font-size: 14px; color: var(--text-secondary); margin-top: 6px; font-weight: 700;">${reading.context} ‚Ä¢ ${reading.date}</div>
        </div>`;
    });
    html += '</div>';
    container.innerHTML = html;
}

// ==================== CALENDAR ====================
function viewCalendar() {
    document.getElementById("dashboardScreen").classList.remove("active");
    document.getElementById("calendarScreen").classList.add("active");
    pushNavigation('calendar');
    renderCalendar();
}

function closeCalendarScreen() {
    document.getElementById("calendarScreen").classList.remove("active");
    document.getElementById("dashboardScreen").classList.add("active");
    popNavigation();
}

function previousMonth() {
    currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1);
    renderCalendar();
}

function nextMonth() {
    currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1);
    renderCalendar();
}

function renderCalendar() {
    const year = currentCalendarMonth.getFullYear();
    const month = currentCalendarMonth.getMonth();
    
    document.getElementById("calendarMonth").textContent = currentCalendarMonth.toLocaleDateString("en-US", {
        month: "long", year: "numeric"
    });
    
    const firstDay = new Date(year, month, 1);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const daysContainer = document.getElementById("calendarDays");
    daysContainer.innerHTML = "";
    
    const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
    const medications = JSON.parse(localStorage.getItem("medications_" + patientCode) || "[]");
    const appointments = JSON.parse(localStorage.getItem("appointments_" + patientCode) || "[]");
    
    const today = new Date();
    const todayDate = new Date();
    todayDate.setHours(0, 0, 0, 0);
    
    for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);
        
        const dayDiv = document.createElement("div");
        dayDiv.style.cssText = "aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg-glass); backdrop-filter: blur(12px); border-radius: 12px; cursor: pointer; transition: all 0.2s; padding: 6px; border: 2px solid rgba(102, 126, 234, 0.2); box-shadow: var(--shadow-sm);";
        
        if (date.getMonth() !== month) {
            dayDiv.style.opacity = "0.35";
        }
        
        // Check if this date has an appointment
        const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD format
        const hasAppointment = appointments.some(appt => appt.date === dateStr);
        
        if (hasAppointment) {
            dayDiv.style.borderColor = "#9333ea"; // Purple for appointments
            dayDiv.style.borderWidth = "3px";
            dayDiv.style.background = "rgba(147, 51, 234, 0.1)";
        }
        
        if (date.toDateString() === todayDate.toDateString()) {
            dayDiv.style.borderColor = "var(--accent-primary)";
            dayDiv.style.fontWeight = "900";
            dayDiv.style.borderWidth = "2px";
        }
        
        const dayNumber = document.createElement("div");
        dayNumber.style.cssText = "font-size: 14px; color: var(--text-primary); margin-bottom: 4px; font-weight: 800;";
        dayNumber.textContent = date.getDate();
        dayDiv.appendChild(dayNumber);
        
        // Show appointment icon if there's an appointment
        if (hasAppointment) {
            const apptIcon = document.createElement("div");
            apptIcon.style.cssText = "font-size: 12px; margin-bottom: 2px;";
            apptIcon.textContent = "üìÖ";
            dayDiv.appendChild(apptIcon);
        }
        
        const dotsContainer = document.createElement("div");
        dotsContainer.style.cssText = "display: flex; gap: 3px; flex-wrap: wrap; justify-content: center;";
        
        medications.forEach(med => {
            med.times.forEach(time => {
                const medKey = `${med.name}-${time}`;
                const takenKey = `taken-${medKey}-${date.toDateString()}`;
                
                const dot = document.createElement("div");
                dot.style.cssText = "width: 6px; height: 6px; border-radius: 50%;";
                
                if (date < todayDate) {
                    dot.style.background = localStorage.getItem(takenKey) ? "#48bb78" : "#fc8181";
                } else if (date.toDateString() === todayDate.toDateString()) {
                    if (localStorage.getItem(takenKey)) {
                        dot.style.background = "#48bb78";
                    } else {
                        const [hour, minute] = time.split(":").map(Number);
                        const medTime = new Date();
                        medTime.setHours(hour, minute, 0, 0);
                        
                        if (today > medTime && (today - medTime) > 900000) {
                            dot.style.background = "#fc8181";
                        } else {
                            dot.style.background = "#fbbf24";
                        }
                    }
                } else {
                    dot.style.background = "#fbbf24";
                }
                
                dotsContainer.appendChild(dot);
            });
        });
        
        dayDiv.appendChild(dotsContainer);
        daysContainer.appendChild(dayDiv);
    }
}

// JavaScript - Add in <script> section (around line 2900)

function openDeletionRequest() {
    const patientCode = currentUser.role === 'patient' ? currentUser.code : currentUser.patients[0].code;
    
    if (localStorage.getItem('deletionRequested_' + patientCode)) {
        showToast('‚ö†Ô∏è Deletion already requested');
        return;
    }
    
    document.getElementById('deletionCode').textContent = patientCode;
    openModal('deletionModal');
}

async function confirmDeletion() {
    const patientCode = currentUser.role === 'patient' ? currentUser.code : currentUser.patients[0].code;
    const codeHash = currentUser.role === 'patient' ? currentUser.codeHash : currentUser.patients[0].codeHash;
    
    showToast('üîÑ Submitting deletion request...');
    
    try {
        const result = await apiCall('/api/account/request-deletion', 'POST', {
            codeHash: codeHash,
            patientCode: patientCode,
            requestedAt: new Date().toISOString()
        });
        
        if (result.success) {
            localStorage.setItem('deletionRequested_' + patientCode, 'true');
            
            const btn = document.getElementById('deletionBtn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = '‚úì Deletion Requested';
                btn.style.background = '#94a3b8';
            }
            
            closeModal('deletionModal');
            showToast('‚úì Request submitted. Account will be deleted within 30 days.');
            
            setTimeout(() => logoutUser(), 3000);
        } else {
            showToast('‚ùå Failed to submit request');
        }
    } catch (error) {
        console.error('Deletion request error:', error);
        showToast('‚ùå Error submitting request');
    }
}
// ==================== ALARMS ====================
function startAlarmChecker() {
    if (alarmCheckInterval) clearInterval(alarmCheckInterval);
    alarmCheckInterval = setInterval(checkMedicationAlarms, 30000);
    checkMedicationAlarms();
}

function checkMedicationAlarms() {
    if (!currentUser || currentUser.role !== "patient") return;
    
    const now = new Date();
    const currentTime = `${now.getHours().toString().padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}`;
    
    const medications = JSON.parse(localStorage.getItem("medications_" + currentUser.code) || "[]");
    
    medications.forEach(med => {
        med.times.forEach(time => {
            if (time === currentTime) {
                const medKey = `${med.name}-${time}`;
                const takenKey = `taken-${medKey}-${now.toDateString()}`;
                
                if (!localStorage.getItem(takenKey)) {
                    triggerPatientAlarm(med, time, medKey);
                }
            }
        });
    });
}

function triggerPatientAlarm(medication, time, medKey) {
    if (activeAlarm === medKey) return;
    
    activeAlarm = medKey;
    playAlarmSound();
    showAlarmModal(medication, time, medKey);
}

function playAlarmSound() {
    try {
        // Create a pleasant chime sound using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Function to play a single chime note
        const playChime = (frequency, startTime, duration) => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = 'sine'; // Smooth sine wave
            oscillator.frequency.value = frequency;
            
            // Gentle fade in and out envelope
            gainNode.gain.setValueAtTime(0, startTime);
            gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
            
            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
            
            return oscillator;
        };
        
        // Pleasant ascending chime melody (C5, E5, G5)
        const now = audioContext.currentTime;
        const chimePattern = [
            { freq: 523.25, time: 0, duration: 0.4 },    // C5
            { freq: 659.25, time: 0.15, duration: 0.4 }, // E5
            { freq: 783.99, time: 0.3, duration: 0.6 }   // G5
        ];
        
        // Play the chime pattern repeatedly
        let currentTime = now;
        const playPattern = () => {
            chimePattern.forEach(note => {
                playChime(note.freq, currentTime + note.time, note.duration);
            });
            currentTime += 2; // Repeat every 2 seconds
        };
        
        // Play first pattern immediately
        playPattern();
        
        // Set up repeating pattern
        const chimeInterval = setInterval(() => {
            if (activeAlarm) {
                playPattern();
            } else {
                clearInterval(chimeInterval);
            }
        }, 2000);
        
        alarmAudio = { audioContext, chimeInterval };
        
        // Add gentle vibration
        vibrateAlarm();
        
    } catch (error) {
        console.error("Audio error:", error);
        vibrateAlarm();
    }
}

function createWavBlob(samples, sampleRate) {
    const buffer = new ArrayBuffer(44 + samples.length);
    const view = new DataView(buffer);
    
    // WAV header
    const writeString = (offset, string) => {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    };
    
    writeString(0, 'RIFF');
    view.setUint32(4, 36 + samples.length, true);
    writeString(8, 'WAVE');
    writeString(12, 'fmt ');
    view.setUint32(16, 16, true); // fmt chunk size
    view.setUint16(20, 1, true); // PCM format
    view.setUint16(22, 1, true); // mono
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate, true); // byte rate
    view.setUint16(32, 1, true); // block align
    view.setUint16(34, 8, true); // bits per sample
    writeString(36, 'data');
    view.setUint32(40, samples.length, true);
    
    // Write samples
    for (let i = 0; i < samples.length; i++) {
        view.setUint8(44 + i, samples[i]);
    }
    
    return new Blob([buffer], { type: 'audio/wav' });
}

function playWebAudioAlarm() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 1000;
        oscillator.type = 'square';
        gainNode.gain.setValueAtTime(1.0, audioContext.currentTime); // Max volume
        
        oscillator.start();
        
        const beepInterval = setInterval(() => {
            if (!activeAlarm) {
                clearInterval(beepInterval);
                oscillator.stop();
                audioContext.close();
            }
        }, 400);
        
        alarmAudio = {oscillator, gainNode, beepInterval, audioContext};
        
        // CRITICAL: Add vibration that works even when phone is silent
        vibrateAlarm();
    } catch (error) {
        console.error("Audio error:", error);
        // Even if audio fails, still vibrate
        vibrateAlarm();
    }
}

function vibrateAlarm() {
    if (!navigator.vibrate) return;
    
    // Strong vibration pattern: vibrate for 500ms, pause 200ms, repeat
    // Pattern: [vibrate, pause, vibrate, pause, ...]
    const pattern = [500, 200, 500, 200, 500, 200, 500, 200, 500, 200];
    
    // Start continuous vibration
    const vibrateInterval = setInterval(() => {
        if (!activeAlarm) {
            clearInterval(vibrateInterval);
            navigator.vibrate(0); // Stop vibration
            return;
        }
        navigator.vibrate(pattern);
    }, 2500); // Repeat every 2.5 seconds
    
    // Store interval for cleanup
    if (!alarmAudio) alarmAudio = {};
    alarmAudio.vibrateInterval = vibrateInterval;
    
    // Initial vibration
    navigator.vibrate(pattern);
}

// Initialize audio context on user interaction (required for mobile browsers)
let audioContextInitialized = false;
function initializeAudioContext() {
    if (audioContextInitialized) return;
    
    try {
        // Create a silent audio context to unlock audio on mobile
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const buffer = ctx.createBuffer(1, 1, 22050);
        const source = ctx.createBufferSource();
        source.buffer = buffer;
        source.connect(ctx.destination);
        source.start(0);
        
        // Also create a silent audio element
        const audio = new Audio();
        audio.src = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=';
        audio.play().then(() => {
            audioContextInitialized = true;
            console.log('Audio initialized for alarms');
        }).catch(e => {
            console.warn('Audio init warning:', e);
        });
        
        ctx.close();
    } catch (error) {
        console.warn('Audio context init error:', error);
    }
}

function showAlarmModal(medication, time, medKey) {
    const modal = document.createElement("div");
    modal.className = "modal active";
    modal.id = "alarmModal";
    modal.style.zIndex = "10000";
    modal.innerHTML = `<div class="modal-content" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; max-width: 480px; border-radius: 32px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <div style="font-size: 80px; margin-bottom: 20px; animation: gentleBounce 2s ease-in-out infinite;">üíä</div>
        <h2 style="color: white; font-size: 28px; margin-bottom: 24px; font-weight: 700;">Medication Reminder</h2>
        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 24px; border-radius: 20px; margin-bottom: 28px; border: 1px solid rgba(255,255,255,0.2);">
            <div style="font-size: 24px; font-weight: 700; margin-bottom: 12px;">${medication.name}</div>
            <div style="font-size: 18px; margin-bottom: 12px; opacity: 0.9;">${medication.dosage}</div>
            <div style="font-size: 20px; font-weight: 600; opacity: 0.95;">‚è∞ ${time}</div>
        </div>
        <button class="btn btn-success" onclick="markMedicationTaken('${medKey}')" style="font-size: 18px; padding: 18px 32px; margin-bottom: 12px; background: #48bb78; border: none; border-radius: 16px; font-weight: 600; box-shadow: 0 4px 12px rgba(72,187,120,0.4);">‚úì Taken</button>
        <button class="btn btn-secondary" onclick="snoozeAlarm('${medKey}')" style="font-size: 16px; padding: 14px 28px; background: rgba(255,255,255,0.25); color: white; border: none; border-radius: 12px;">‚è∞ Snooze 5 Min</button>
    </div>
    <style>
        @keyframes gentleBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    </style>`;
    
    document.body.appendChild(modal);
}

function markMedicationTaken(medKey) {
    const now = new Date();
    const takenKey = `taken-${medKey}-${now.toDateString()}`;
    localStorage.setItem(takenKey, now.toISOString());
    stopAlarm();
    showToast("‚úì Medication taken!");
    
    // Send to backend for caregiver visibility
    const patientCode = currentUser.role === "patient" ? currentUser.code : currentUser.patients[0].code;
    const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0].codeHash;
    
    // Parse medKey to get medication name and time
    const parts = medKey.split("-");
    const scheduledTime = parts[parts.length - 1];
    const medicationName = parts.slice(0, -1).join("-");
    
    // Record in database
    apiCall('/api/health/medication-taken', 'POST', {
        codeHash: codeHash,
        medicationName: medicationName,
        scheduledTime: scheduledTime,
        takenAt: now.toISOString()
    }).then(() => {
        console.log('‚úÖ Medication adherence recorded in database');
    }).catch(error => {
        console.error('‚ö†Ô∏è Failed to record medication adherence:', error);
        // Continue anyway - localStorage backup is already saved
    });
    
    // Refresh calendar if visible
    if (document.getElementById('calendarScreen').classList.contains('active')) {
        renderCalendar();
    }
    
    // Refresh reminders if visible
    if (document.getElementById('remindersScreen').classList.contains('active')) {
        loadReminders();
    }
    
    // Refresh dashboard if visible
    if (document.getElementById('dashboardScreen').classList.contains('active')) {
        updateDashboardMedicationStatus();
    }
}

function updateDashboardMedicationStatus() {
    // This function can be expanded to show medication status on dashboard
    // For now, it ensures UI updates when medications are marked as taken
    console.log('Dashboard medication status updated');
}

function snoozeAlarm(medKey) {
    stopAlarm();
    showToast("‚è∞ Snoozed 5 minutes");
    
    setTimeout(() => {
        const takenKey = `taken-${medKey}-${new Date().toDateString()}`;
        if (!localStorage.getItem(takenKey)) {
            const parts = medKey.split("-");
            const medName = parts.slice(0, -1).join("-");
            const time = parts[parts.length - 1];
            triggerPatientAlarm({name: medName, dosage: "as prescribed"}, time, medKey);
        }
    }, 300000);
}

function stopAlarm() {
    activeAlarm = null;
    
    if (alarmAudio) {
        // Stop HTML5 Audio (legacy fallback)
        if (alarmAudio.audioElement) {
            alarmAudio.audioElement.pause();
            alarmAudio.audioElement.currentTime = 0;
            if (alarmAudio.audioElement.src) {
                URL.revokeObjectURL(alarmAudio.audioElement.src);
            }
        }
        // Stop chime interval
        if (alarmAudio.chimeInterval) clearInterval(alarmAudio.chimeInterval);
        // Stop Web Audio API
        if (alarmAudio.beepInterval) clearInterval(alarmAudio.beepInterval);
        if (alarmAudio.oscillator) {
            try { alarmAudio.oscillator.stop(); } catch (e) {}
        }
        if (alarmAudio.audioContext) {
            try { alarmAudio.audioContext.close(); } catch (e) {}
        }
        if (alarmAudio.vibrateInterval) clearInterval(alarmAudio.vibrateInterval);
        alarmAudio = null;
    }
    
    // Stop vibration
    if (navigator.vibrate) {
        navigator.vibrate(0);
    }
    
    const modal = document.getElementById("alarmModal");
    if (modal) modal.remove();
}

function testAlarm() {
    if (confirm("Test alarm now?")) {
        const testMed = {name: "TEST MED", dosage: "100mg (test)"};
        const now = new Date();
        const testTime = `${now.getHours().toString().padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}`;
        triggerPatientAlarm(testMed, testTime, "test-" + Date.now());
    }
}

async function toggleTier() {
    // Everyone is premium - no tier changes allowed
    showToast('All users have premium access!');
    return;
}
// ==================== INIT ====================
document.getElementById("termsAccept")?.addEventListener("change", function() {
    document.getElementById("registerBtn").disabled = !this.checked;
});

document.getElementById("caregiverTerms")?.addEventListener("change", function() {
    document.getElementById("connectBtn").disabled = !this.checked;
});

// Navigation stack management
let navigationStack = ['home'];
let preventExit = true;

function pushNavigation(screen) {
    navigationStack.push(screen);
    history.pushState({screen: screen}, '', '');
}

function popNavigation() {
    if (navigationStack.length > 1) {
        navigationStack.pop();
        return navigationStack[navigationStack.length - 1];
    }
    return 'home';
}

// Handle back button properly
window.addEventListener('popstate', function(event) {
    if (navigationStack.length > 1) {
        // Navigate back within app
        const previousScreen = popNavigation();
        handleInternalNavigation(previousScreen);
        // Push state again to maintain stack
        history.pushState({screen: previousScreen}, '', '');
    } else {
        // User is at home screen - allow exit without confirmation
        preventExit = false;
        window.history.back();
    }
});

function handleInternalNavigation(screen) {
    // Close all screens first
    document.querySelectorAll('.dashboard, .camera-screen, .medications-screen, .reminders-screen, .health-screen, .aiAnalysis-screen').forEach(el => {
        el.classList.remove('active');
    });
    
    // Show appropriate screen
    if (screen === 'home') {
        document.getElementById('homeScreen').style.display = 'flex';
    } else if (screen === 'dashboard') {
        document.getElementById('dashboardScreen').classList.add('active');
    } else if (screen === 'camera') {
        document.getElementById('cameraScreen').classList.add('active');
    } else if (screen === 'medications') {
        document.getElementById('medicationsScreen').classList.add('active');
    } else if (screen === 'reminders') {
        document.getElementById('remindersScreen').classList.add('active');
    } else if (screen === 'health') {
        document.getElementById('healthScreen').classList.add('active');
    } else if (screen === 'aiChat') {
        document.getElementById('aiChatScreen').classList.add('active');
    } else if (screen === 'aiAnalysis') {
        document.getElementById('aiAnalysisScreen').classList.add('active');
    } else if (screen === 'calendar') {
        document.getElementById('calendarScreen').classList.add('active');
    }
}

    // ==================== BRAIN GAMES ====================

let currentGame = null;
let gameStartTime = null;
let gameTimerInterval = null;
let gameScore = { correct: 0, total: 0 };
let currentQuestion = null;
let gameRecognition = null;

function startBrainGames() {
    document.getElementById("dashboardScreen").classList.remove("active");
    document.getElementById("brainGamesScreen").classList.add("active");
    pushNavigation('brainGames');
    
    // Show game selection, hide game play
    document.getElementById('gameSelection').style.display = 'block';
    document.getElementById('gamePlayArea').style.display = 'none';
}

function closeBrainGamesScreen() {
    if (currentGame) {
        if (confirm("End current game?")) {
            endGame();
        } else {
            return;
        }
    }
    
    document.getElementById("brainGamesScreen").classList.remove("active");
    document.getElementById("dashboardScreen").classList.add("active");
    popNavigation();
}

function startGame(gameType) {
    currentGame = gameType;
    gameStartTime = Date.now();
    gameScore = { correct: 0, total: 0 };
    
    // Hide selection, show game
    document.getElementById('gameSelection').style.display = 'none';
    document.getElementById('gamePlayArea').style.display = 'block';
    
    // Set game title and emoji
    const titles = {
        'math': { title: 'üå∏ Math Garden', emoji: 'üå∏' },
        'words': { title: 'üí¨ Word Friends', emoji: 'üí¨' },
        'memory': { title: 'üéØ Remember & Repeat', emoji: 'üéØ' }
    };
    
    document.getElementById('gameTitle').textContent = titles[gameType].title;
    document.getElementById('questionEmoji').textContent = titles[gameType].emoji;
    
    // Start timer
    startGameTimer();
    
    // Initialize speech recognition
    initGameSpeechRecognition();
    
    // Load first question
    nextQuestion();
}

function startGameTimer() {
    let seconds = 0;
    gameTimerInterval = setInterval(() => {
        seconds++;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        document.getElementById('gameTimer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }, 1000);
}

function initGameSpeechRecognition() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.log('Speech recognition not supported');
        return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    gameRecognition = new SpeechRecognition();
    gameRecognition.continuous = false;
    gameRecognition.interimResults = false;
    gameRecognition.lang = 'en-US';
    
    gameRecognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript.toLowerCase().trim();
        document.getElementById('gameVoiceStatus').style.display = 'none';
        handleGameAnswer(transcript);
    };
    
    gameRecognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        document.getElementById('gameVoiceStatus').style.display = 'none';
        if (event.error === 'no-speech') {
            showToast('‚ö†Ô∏è No speech detected. Try again.');
            startGameVoiceInput();
        }
    };
    
    gameRecognition.onend = function() {
        document.getElementById('gameVoiceStatus').style.display = 'none';
    };
}

function nextQuestion() {
    if (currentGame === 'math') {
        showMathQuestion();
    } else if (currentGame === 'words') {
        showWordsQuestion();
    } else if (currentGame === 'memory') {
        showMemoryQuestion();
    }
}

// ==================== MATH GARDEN ====================

function showMathQuestion() {
    const num1 = Math.floor(Math.random() * 10) + 1;
    const num2 = Math.floor(Math.random() * 10) + 1;
    const operation = Math.random() > 0.5 ? '+' : '-';
    
    let question, answer;
    if (operation === '+') {
        question = `${num1} + ${num2}`;
        answer = num1 + num2;
    } else {
        // Ensure no negative answers
        const larger = Math.max(num1, num2);
        const smaller = Math.min(num1, num2);
        question = `${larger} - ${smaller}`;
        answer = larger - smaller;
    }
    
    currentQuestion = { text: question, answer: answer.toString() };
    
    document.getElementById('questionText').textContent = question + ' = ?';
    
    // Voice: Ask the question
    speakText(`What is ${question.replace('+', 'plus').replace('-', 'minus')}?`);
    
    // --- START FIX: Conditional Answer Input HTML ---
    let voiceButtonHTML = '';
    if (!isIPadOS()) {
        // Only include the voice button if it's NOT an iPad
        voiceButtonHTML = `<button class="btn btn-secondary" onclick="startGameVoiceInput()" style="background: var(--accent-gradient);">üé§ Say Answer</button>`;
    }

    // Show answer input
    document.getElementById('answerInput').innerHTML = `
        <input type="number" id="mathAnswer" placeholder="Your answer" 
                style="font-size: 28px; padding: 16px; text-align: center; border: 3px solid var(--accent-primary); border-radius: 16px; width: 200px; font-weight: 900;"
                onkeypress="if(event.key==='Enter') submitMathAnswer()">
        <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: center;">
            <button class="btn btn-primary" onclick="submitMathAnswer()">Submit Answer</button>
            ${voiceButtonHTML} 
        </div>
    `;
    // --- END FIX ---
    
    // Auto-focus input
    setTimeout(() => document.getElementById('mathAnswer')?.focus(), 100);
}
function submitMathAnswer() {
    const userAnswer = document.getElementById('mathAnswer')?.value;
    if (!userAnswer) {
        showToast('Please enter an answer');
        return;
    }
    handleGameAnswer(userAnswer);
}

// ==================== WORD FRIENDS ====================

const wordCategories = {
    animals: ['dog', 'cat', 'bird', 'fish', 'horse', 'cow', 'pig', 'sheep', 'chicken', 'duck'],
    foods: ['apple', 'bread', 'milk', 'cheese', 'egg', 'rice', 'pasta', 'potato', 'carrot', 'banana'],
    colors: ['red', 'blue', 'green', 'yellow', 'orange', 'purple', 'pink', 'black', 'white', 'brown'],
    family: ['mother', 'father', 'sister', 'brother', 'grandma', 'grandpa', 'aunt', 'uncle', 'cousin', 'child']
};

function showWordsQuestion() {
const categories = Object.keys(wordCategories);
    const category = categories[Math.floor(Math.random() * categories.length)];
    const words = wordCategories[category];
    const word = words[Math.floor(Math.random() * words.length)];
    
    currentQuestion = { category: category, word: word, answer: 'any' };
    
    document.getElementById('questionText').textContent = `I say: ${word.toUpperCase()}`;
    
    // Voice: Ask the question
    speakText(`I say ${word}. You say a related word.`);
    
    // --- START FIX: Conditional Answer Input HTML ---
    let voiceButtonHTML = '';
    if (!isIPadOS()) {
        voiceButtonHTML = `<button class="btn btn-secondary" onclick="startGameVoiceInput()" style="background: #48bb78; color: white;">üé§ Say Answer</button>`;
    }

    // Show answer input
    document.getElementById('answerInput').innerHTML = `
        <input type="text" id="wordAnswer" placeholder="Say a related word" 
                style="font-size: 24px; padding: 16px; text-align: center; border: 3px solid #48bb78; border-radius: 16px; width: 100%; max-width: 400px; font-weight: 700;"
                onkeypress="if(event.key==='Enter') submitWordAnswer()">
        <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: center;">
            <button class="btn btn-success" onclick="submitWordAnswer()">Submit Answer</button>
            ${voiceButtonHTML}
        </div>
    `;
    // --- END FIX ---
    
    setTimeout(() => document.getElementById('wordAnswer')?.focus(), 100);
}

function submitWordAnswer() {
    const userAnswer = document.getElementById('wordAnswer')?.value;
    if (!userAnswer) {
        showToast('Please enter a word');
        return;
    }
    handleGameAnswer(userAnswer);
}

// ==================== REMEMBER & REPEAT ====================

function showMemoryQuestion() {
    const items = ['apple', 'milk', 'bread', 'eggs', 'butter', 'cheese', 'rice', 'pasta', 'chicken', 'fish'];
    const count = Math.min(3 + Math.floor(gameScore.total / 5), 6); // Start with 3, max 6
    const sequence = [];
    for (let i = 0; i < count; i++) {
        sequence.push(items[Math.floor(Math.random() * items.length)]);
    }
    
    currentQuestion = { sequence: sequence, answer: sequence.join(' ') };
    
    document.getElementById('questionText').textContent = 'Listen carefully...';
    document.getElementById('answerInput').innerHTML = `
        <div style="font-size: 18px; color: var(--text-secondary); font-weight: 600;">I'll say ${count} items. Remember them!</div>
    `;
    
    // Voice: Say the sequence
    const sequenceText = sequence.join(', ');
    speakText(`Remember these: ${sequenceText}. Now tell me what you remember.`);
    
    // After voice finishes, show input
    setTimeout(() => {
        document.getElementById('questionText').textContent = 'What did I say?';
        
        // --- START FIX: Conditional Answer Input HTML ---
        let voiceButtonHTML = '';
        if (!isIPadOS()) {
            voiceButtonHTML = `<button class="btn btn-secondary" onclick="startGameVoiceInput()" style="background: #f59e0b; color: white;">üé§ Say Answer</button>`;
        }
        
        document.getElementById('answerInput').innerHTML = `
            <input type="text" id="memoryAnswer" placeholder="Tell me the items" 
                    style="font-size: 20px; padding: 16px; text-align: center; border: 3px solid #f59e0b; border-radius: 16px; width: 100%; max-width: 500px; font-weight: 700;"
                    onkeypress="if(event.key==='Enter') submitMemoryAnswer()">
            <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: center;">
                <button class="btn btn-primary" onclick="submitMemoryAnswer()" style="background: var(--warning-gradient);">Submit Answer</button>
                ${voiceButtonHTML} 
            </div>
        `;
        // --- END FIX ---
        
        setTimeout(() => document.getElementById('memoryAnswer')?.focus(), 100);
    }, (count * 1000) + 2000); // Wait for speech + 2 seconds
}

function submitMemoryAnswer() {
    const userAnswer = document.getElementById('memoryAnswer')?.value;
    if (!userAnswer) {
        showToast('Please enter the items');
        return;
    }
    handleGameAnswer(userAnswer);
}

// ==================== GAME ANSWER HANDLING ====================

function handleGameAnswer(userAnswer) {
    gameScore.total++;
    let isCorrect = false;
    
    if (currentGame === 'math') {
        isCorrect = userAnswer.toString() === currentQuestion.answer;
    } else if (currentGame === 'words') {
        // Word game: any answer is correct (encourages engagement)
        isCorrect = userAnswer.length > 0;
    } else if (currentGame === 'memory') {
        // Memory: Check if at least 50% of items are remembered
        const userItems = userAnswer.toLowerCase().split(/[,\s]+/).filter(w => w.length > 2);
        const correctItems = currentQuestion.sequence;
        const matches = userItems.filter(item => correctItems.some(correct => correct.includes(item) || item.includes(correct)));
        isCorrect = matches.length >= Math.ceil(correctItems.length / 2);
    }
    
    if (isCorrect) {
        gameScore.correct++;
        showGameFeedback(true);
    } else {
        showGameFeedback(false);
    }
    
    // Update scores
    document.getElementById('correctScore').textContent = gameScore.correct;
    document.getElementById('totalScore').textContent = gameScore.total;
    
    // Next question after 2 seconds
    setTimeout(() => {
        nextQuestion();
    }, 2000);
}

function showGameFeedback(isCorrect) {
    const questionDisplay = document.getElementById('questionDisplay');
    const emoji = document.getElementById('questionEmoji');
    
    if (isCorrect) {
        emoji.textContent = '‚úÖ';
        questionDisplay.style.background = 'linear-gradient(135deg, rgba(72, 187, 120, 0.2), rgba(56, 161, 105, 0.2))';
        speakText('Great job!');
        
        // Grow a flower
        const flower = document.createElement('div');
        flower.textContent = 'üå∏';
        flower.style.cssText = 'position: fixed; font-size: 48px; animation: growFlower 2s ease; pointer-events: none; z-index: 9999;';
        flower.style.left = (Math.random() * 80 + 10) + '%';
        flower.style.top = (Math.random() * 50 + 25) + '%';
        document.body.appendChild(flower);
        setTimeout(() => flower.remove(), 2000);
    } else {
        emoji.textContent = '‚ùå';
        questionDisplay.style.background = 'linear-gradient(135deg, rgba(252, 129, 129, 0.2), rgba(245, 101, 101, 0.2))';
        speakText('Try again next time!');
    }
    
    setTimeout(() => {
        emoji.textContent = currentGame === 'math' ? 'üå∏' : currentGame === 'words' ? 'üí¨' : 'üéØ';
        questionDisplay.style.background = 'var(--bg-primary)';
    }, 2000);
}

// Add CSS for flower animation
const flowerStyle = document.createElement('style');
flowerStyle.textContent = `
    @keyframes growFlower {
        0% { transform: scale(0) rotate(0deg); opacity: 0; }
        50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
        100% { transform: scale(1) rotate(360deg); opacity: 0; }
    }
`;
document.head.appendChild(flowerStyle);

function startGameVoiceInput() {
    if (!gameRecognition) {
        showToast('Voice input not available');
        return;
    }
    
    try {
        gameRecognition.start();
        document.getElementById('gameVoiceStatus').style.display = 'block';
    } catch (error) {
        console.error('Voice input error:', error);
    }
}

function endGame() {
    if (!confirm(`End game now?\n\nScore: ${gameScore.correct}/${gameScore.total}`)) {
        return;
    }
    
    // Stop timer
    if (gameTimerInterval) {
        clearInterval(gameTimerInterval);
        gameTimerInterval = null;
    }
    
    // Calculate duration
    const durationSeconds = Math.floor((Date.now() - gameStartTime) / 1000);
    
    // Save to backend
    const codeHash = currentUser.role === "patient" ? currentUser.codeHash : currentUser.patients[0]?.codeHash;
    if (codeHash) {
        apiCall('/api/brain-games/session', 'POST', {
            codeHash: codeHash,
            gameType: currentGame,
            durationSeconds: durationSeconds,
            correctAnswers: gameScore.correct,
            totalQuestions: gameScore.total
        }).then(() => {
            console.log('Game session saved');
        }).catch(error => {
            console.error('Failed to save game session:', error);
        });
    }
    
    // Show results
    alert(`üéâ Game Complete!\n\nCorrect: ${gameScore.correct}/${gameScore.total}\nAccuracy: ${Math.round(gameScore.correct / gameScore.total * 100)}%\nTime: ${Math.floor(durationSeconds / 60)}:${(durationSeconds % 60).toString().padStart(2, '0')}`);
    
    // Reset game
    currentGame = null;
    gameStartTime = null;
    
    // Back to selection
    document.getElementById('gameSelection').style.display = 'block';
    document.getElementById('gamePlayArea').style.display = 'none';
}

// Add Brain Games to caregiver dashboard
function viewGameHistory() {
    // This will be called by caregivers to see patient's game activity
    // We'll add this later if needed
    showToast('Game history feature coming soon!');
}

window.addEventListener("load", async () => {

        initOnboarding();
    
    // Initialize navigation stack
    history.pushState({screen: 'home'}, '', '');
    // Initialize navigation stack
    history.pushState({screen: 'home'}, '', '');
    
    const darkMode = localStorage.getItem("darkMode");
    if (darkMode === "enabled") {
        document.body.classList.add("dark-mode");
        document.querySelector(".dark-mode-toggle").textContent = "‚òÄÔ∏è";
    }
    
    // Check if user is already logged in
    const savedUser = localStorage.getItem("currentUser");
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        
        // Load tier
        userTier = currentUser.tier || localStorage.getItem('userTier') || 'premium';
        
        // IMMEDIATELY go to dashboard (don't wait for backend)
        console.log('‚úÖ Restored session from localStorage');
        goToDashboard();
        
        // Record anonymous app launch (background)
        recordAppLaunch();
        
        // Update connection status in background (don't block)
        updateConnectionStatus(false); // Start as offline
        
        // Validate session in background (non-blocking)
        if (currentUser.code) {
            apiCall('/api/patient/login', 'POST', {patientCode: currentUser.code})
                .then(result => {
                    if (result.success) {
                        console.log('‚úÖ Session validated with backend');
                        updateConnectionStatus(true);
                        
                        // Update tier if changed
                        if (result.patient && result.patient.tier) {
                            userTier = result.patient.tier;
                            currentUser.tier = userTier;
                            localStorage.setItem('userTier', userTier);
                            localStorage.setItem("currentUser", JSON.stringify(currentUser));
                        }
                        
                        // Update codeHash if provided
                        if (result.codeHash) {
                            currentUser.codeHash = result.codeHash;
                            localStorage.setItem("currentUser", JSON.stringify(currentUser));
                        }
                    } else {
                        console.log('‚ö†Ô∏è Backend validation failed - using cached session');
                        updateConnectionStatus(false);
                    }
                })
                .catch(error => {
                    console.log('‚ö†Ô∏è Backend offline - using cached session');
                    updateConnectionStatus(false);
                });
        }
    } else {
        // No saved user - stay on login screen
        console.log('No saved session - showing login screen');
        
        // Check backend connectivity for new users
        updateConnectionStatus(false);
        fetch(API_BASE_URL + '/api/patient/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({patientCode: 'TEST_CONNECTION'}),
            signal: AbortSignal.timeout(3000)
        })
        .then(response => {
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                console.log('‚úÖ Backend connected');
                updateConnectionStatus(true);
            }
        })
        .catch(error => {
            console.log('‚ö†Ô∏è Backend offline');
            updateConnectionStatus(false);
        });
    }
});

// ==================== FEATURE 1: ANONYMOUS MONTHLY CAREGIVER BURDEN SURVEY ====================

function checkAndShowSurveyBanner() {
    // Only show for caregivers
    if (!currentUser || currentUser.role !== 'caregiver') return;
    
    const codeHash = currentUser.codeHash;
    
    apiCall('/api/survey/check-eligibility/' + codeHash, 'GET')
        .then(result => {
            if (result.eligible) {
                showSurveyBanner(result.surveyDay, result.surveyUrl, result.accountAgeDays);
            }
        })
        .catch(error => {
            console.error('Survey eligibility check failed:', error);
        });
}

function showSurveyBanner(surveyDay, surveyUrl, accountAgeDays) {
    // Check if banner was dismissed today
    const dismissKey = `surveyDismissed_day${surveyDay}_${new Date().toDateString()}`;
    if (localStorage.getItem(dismissKey)) return;
    
    const banner = document.createElement('div');
    banner.id = 'surveyBanner';
    banner.style.cssText = `
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        max-width: 600px;
        width: 90%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideDown 0.5s ease;
    `;
    
    banner.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
            <div style="font-size: 28px;">üìã</div>
            <button onclick="dismissSurveyBanner('${dismissKey}')" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; padding: 4px 12px; border-radius: 8px;">√ó</button>
        </div>
        <div style="font-size: 20px; font-weight: 900; margin-bottom: 12px;">Anonymous Caregiver Check-In</div>
        <div style="font-size: 15px; margin-bottom: 8px; opacity: 0.95;">You've been using the app for ${accountAgeDays} days! Help us measure our impact by completing a quick, anonymous 2-minute survey.</div>
        <div style="font-size: 13px; margin-bottom: 20px; opacity: 0.85;">‚úì Completely anonymous - no personal data collected<br>‚úì Helps improve the app for all caregivers<br>‚úì Takes only 2 minutes</div>
        <button onclick="openSurvey('${surveyUrl}', ${surveyDay}, '${dismissKey}')" style="background: white; color: #667eea; border: none; padding: 14px 28px; border-radius: 12px; font-weight: 800; font-size: 16px; cursor: pointer; width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
            Take Anonymous Check-In (2 Minutes) ‚Üí
        </button>
    `;
    
    document.body.appendChild(banner);
}

function dismissSurveyBanner(dismissKey) {
    const banner = document.getElementById('surveyBanner');
    if (banner) {
        banner.style.animation = 'slideUp 0.3s ease';
        setTimeout(() => banner.remove(), 300);
    }
    localStorage.setItem(dismissKey, 'true');
}

function openSurvey(surveyUrl, surveyDay, dismissKey) {
    // Open survey in new tab
    window.open(surveyUrl, '_blank');
    
    // Dismiss banner
    dismissSurveyBanner(dismissKey);
    
    // Note: Survey completion is recorded externally via webhook/API
    // The survey platform will call /api/survey/record-completion when user submits
}

// ==================== FEATURE 2: CUMULATIVE DAILY ACTIVE USER (DAU) TRACKING ====================

function recordAppLaunch() {
    if (!currentUser) return;
    
    const codeHash = currentUser.role === 'patient' ? currentUser.codeHash : currentUser.patients[0]?.codeHash;
    if (!codeHash) return;
    
    // Check if we already recorded launch today (client-side optimization)
    const todayKey = 'appLaunch_' + new Date().toDateString();
    if (localStorage.getItem(todayKey)) {
        console.log('üìä DAU: Already recorded today (cached)');
        return;
    }
    
    apiCall('/api/analytics/app-launch', 'POST', { codeHash: codeHash })
        .then(result => {
            if (result.counted) {
                console.log('üìä DAU: Unique daily launch recorded (anonymized)');
                localStorage.setItem(todayKey, 'true');
            } else {
                console.log('üìä DAU: Already counted for today');
            }
        })
        .catch(error => {
            console.error('DAU tracking error:', error);
        });
}

// Add CSS animation for survey banner
const style = document.createElement('style');
style.textContent = `
    @keyframes slideDown {
        from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    @keyframes slideUp {
        from { transform: translateX(-50%) translateY(0); opacity: 1; }
        to { transform: translateX(-50%) translateY(-100px); opacity: 0; }
    }
`;
document.head.appendChild(style);
// Service Worker Registration - ADD THIS BEFORE </body>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
                console.log('‚úì Service Worker registered:', registration.scope);
            })
            .catch(error => {
                console.error('‚úó Service Worker registration failed:', error);
            });
    });
}

async function initializePushNotifications() {
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        console.log('Push notifications not supported');
        return;
    }
    
    try {
        const registration = await navigator.serviceWorker.ready;
        
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            console.log('Notification permission denied');
            return;
        }
        
        const vapidKeyResponse = await apiCall('/api/push/vapid-public-key', 'GET');
        const vapidPublicKey = vapidKeyResponse.publicKey;
        
        if (!vapidPublicKey) {
            console.error('No VAPID key');
            return;
        }
        
        const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
        });
        
        const codeHash = currentUser.role === 'patient' ? currentUser.codeHash : currentUser.patients[0].codeHash;
        
        await apiCall('/api/push/subscribe', 'POST', {
            codeHash: codeHash,
            subscription: subscription.toJSON()
        });
        
        console.log('‚úì Push notifications enabled');
        
    } catch (error) {
        console.error('Push notification setup failed:', error);
    }
}

function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

// AUTO-REFRESH medications after call
setInterval(() => {
    if (currentUser && document.getElementById('remindersScreen').classList.contains('active')) {
        loadReminders();
    }
}, 30000); // Refresh every 30 seconds

        async function requestPushPermission() {
    if (!('Notification' in window)) {
        console.log('No notifications');
        return;
    }
    
    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
        subscribeToPush();
    }
}

async function subscribeToPush() {
    try {
        const registration = await navigator.serviceWorker.ready;
        
        const response = await fetch(API_BASE_URL + '/api/push/vapid-public-key');
        const data = await response.json();
        
        const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(data.publicKey)
        });
        
        const codeHash = currentUser.role === 'patient' ? currentUser.codeHash : currentUser.patients[0].codeHash;
        
        await fetch(API_BASE_URL + '/api/push/subscribe', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                codeHash: codeHash,
                subscription: subscription.toJSON()
            })
        });
        
        console.log('‚úÖ Push enabled');
    } catch (e) {
        console.error('Push failed:', e);
    }
}

function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

// ==================== AI INSIGHTS ====================
async function showAIInsights() {
    try {
        const codeHash = currentUser.role === 'patient' ? currentUser.codeHash : currentUser.patients[0].codeHash;
        const response = await fetch(API_BASE_URL + '/api/health/records/' + codeHash);
        const data = await response.json();
        
        if (!data.success || !data.records || data.records.length === 0) {
            alert('No AI insights available yet. Scan a prescription to generate insights.');
            return;
        }
        
        const latestInsight = data.records.find(r => r.recordType === 'ai_analysis' && r.metadata && r.metadata.aiInsights);
        
        if (!latestInsight) {
            alert('No AI insights available yet. Scan a prescription to generate insights.');
            return;
        }
        
        const analysis = latestInsight.metadata.aiInsights.analysis || "No analysis available";
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;';
        modal.innerHTML = '<div style="background: white; border-radius: 20px; padding: 32px; max-width: 600px; max-height: 80vh; overflow-y: auto; width: 100%;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;"><h2 style="margin: 0; font-size: 24px; font-weight: 900; color: #1f2937;">ü§ñ AI Health Insights</h2><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background: none; border: none; font-size: 32px; cursor: pointer; color: #6b7280;">√ó</button></div><div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 16px; border-radius: 8px; margin-bottom: 24px;"><div style="font-weight: 700; color: #92400e; margin-bottom: 8px;">‚ö†Ô∏è Important Disclaimer</div><div style="color: #78350f; font-size: 14px;">This is caregiving guidance only, NOT medical advice.</div></div><div style="white-space: pre-wrap; line-height: 1.8; color: #374151; font-size: 15px;">' + analysis.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div></div>';
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
    } catch (error) {
        console.error('AI insights error:', error);
        alert('Failed to load AI insights');
    }
}

        // ==================== ONBOARDING ====================
let currentOnboardingSlide = 0;
const totalOnboardingSlides = 8;

function initOnboarding() {
    const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding');
    
    if (!hasSeenOnboarding) {
        document.getElementById('onboardingScreen').classList.add('active');
        document.getElementById('homeScreen').style.display = 'none';
        renderOnboardingDots();
    }
}

function renderOnboardingDots() {
    const dotsContainer = document.getElementById('onboardingDots');
    dotsContainer.innerHTML = '';
    
    for (let i = 0; i < totalOnboardingSlides; i++) {
        const dot = document.createElement('div');
        dot.className = 'onboarding-dot' + (i === currentOnboardingSlide ? ' active' : '');
        dotsContainer.appendChild(dot);
    }
}

function nextOnboardingSlide() {
    const slides = document.querySelectorAll('.onboarding-slide');
    slides[currentOnboardingSlide].classList.remove('active');
    
    currentOnboardingSlide++;
    
    if (currentOnboardingSlide >= totalOnboardingSlides) {
        finishOnboarding();
        return;
    }
    
    slides[currentOnboardingSlide].classList.add('active');
    renderOnboardingDots();
    
    // Change button text on last slide
    if (currentOnboardingSlide === totalOnboardingSlides - 1) {
        document.getElementById('nextBtn').textContent = 'Get Started';
    }
}

function skipOnboarding() {
    finishOnboarding();
}

function finishOnboarding() {
    localStorage.setItem('hasSeenOnboarding', 'true');
    document.getElementById('onboardingScreen').classList.remove('active');
    document.getElementById('homeScreen').style.display = 'flex';
}
    </script>
</body>
</html>
