<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Prescription</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f5f5;padding:20px;}
        .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;border-radius:15px;margin-bottom:20px;}
        h1{font-size:24px;}
        .upload-area{background:white;padding:40px;border-radius:15px;text-align:center;margin-bottom:20px;}
        input[type="file"]{display:none;}
        .upload-btn{padding:15px 30px;background:#667eea;color:white;border:none;border-radius:10px;font-size:16px;cursor:pointer;}
        .preview-img{max-width:100%;border-radius:10px;margin:20px 0;display:none;}
        .results{background:white;padding:20px;border-radius:15px;margin-bottom:20px;display:none;}
        .back-btn{display:inline-block;padding:12px 24px;background:white;color:#667eea;text-decoration:none;border-radius:10px;}
        .loading{text-align:center;padding:20px;display:none;}
    </style>
</head>
<body>
    <div class="header"><h1>üì∑ Scan Prescription</h1></div>
    <div class="upload-area">
        <p style="margin-bottom:20px;color:#666;">Take a photo of your prescription</p>
        <label for="imageInput" class="upload-btn">üì∑ Choose Image</label>
        <input type="file" id="imageInput" accept="image/*" capture="environment">
        <img id="preview" class="preview-img">
    </div>
    <div class="loading" id="loading"><p>Processing prescription...</p></div>
    <div class="results" id="results"></div>
    <a href="/patient-dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
    <script>
        const API_BASE=window.location.origin;
        const codeHash=localStorage.getItem('patientCodeHash');
        const patientData=JSON.parse(localStorage.getItem('patientData')||'{}');
        document.getElementById('imageInput').addEventListener('change',async(e)=>{
            const file=e.target.files[0];
            if(!file)return;
            const preview=document.getElementById('preview');
            const reader=new FileReader();
            reader.onload=async(event)=>{
                preview.src=event.target.result;
                preview.style.display='block';
                document.getElementById('loading').style.display='block';
                try{
                    const response=await fetch(`${API_BASE}/api/health/ocr`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({imageData:event.target.result,patientAge:patientData.age,patientGender:patientData.gender})});
                    const data=await response.json();
                    document.getElementById('loading').style.display='none';
                    if(data.success){
                        const meds=data.ocrResult.extracted_data.medications;
                        if(meds&&meds.length>0){
                            await fetch(`${API_BASE}/api/medications/schedule`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({codeHash:codeHash,medications:meds})});
                            document.getElementById('results').innerHTML=`
                                <h2 style="color:#4CAF50;margin-bottom:15px;">‚úì Medications Added</h2>
                                ${meds.map(m=>`
                                    <div style="margin-bottom:15px;padding:15px;background:#f5f5f5;border-radius:8px;">
                                        <strong>${m.name}</strong><br>
                                        ${m.dosage} - ${m.times.join(', ')}
                                    </div>
                                `).join('')}
                                <button onclick="window.location.href='/patient-medicines.html'" class="upload-btn" style="margin-top:15px;">View All Medicines</button>
                            `;
                            document.getElementById('results').style.display='block';
                        }
                    }
                }catch(error){
                    console.error('Scan error:',error);
                    document.getElementById('loading').style.display='none';
                    alert('Scan failed. Please try again.');
                }
            };
            reader.readAsDataURL(file);
        });
    </script>
</body>
</html>